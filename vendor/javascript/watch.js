// watch@1.0.2 downloaded from https://ga.jspm.io/npm:watch@1.0.2/main.js

import e from"util";import i from"fs";import t from"path";import n from"events";var r={};var l=e,f=i,a=t,o=n;function walk(e,i,t){if(!t){t=i;i={}}t.files||(t.files={});t.pending||(t.pending=0);t.pending+=1;f.stat(e,(function(n,r){if(n)return t(n);t.files[e]=r;f.readdir(e,(function(n,r){if(n)return"EACCES"===n.code&&i.ignoreUnreadableDir?t():t(n);t.pending-=1;r.forEach((function(n,r){n=a.join(e,n);t.pending+=1;f.stat(n,(function(e,r){var l=false,f=false;if(e){if("ENOENT"!==e.code&&"EPERM"!==e.code&&i.ignoreNotPermitted)return t(e);l=true}t.pending-=1;f=0===t.pending;if(!l){if(i.ignoreDotFiles&&"."===a.basename(n)[0])return f&&t(null,t.files);if(i.filter&&!i.filter(n,r))return f&&t(null,t.files);t.files[n]=r;!r.isDirectory()||i.ignoreDirectoryPattern&&i.ignoreDirectoryPattern.test(n)||walk(n,i,t);f=0===t.pending;f&&t(null,t.files)}}))}));0===t.pending&&t(null,t.files)}));0===t.pending&&t(null,t.files)}))}var c=Object.create(null);r.watchTree=function(e,i,t){if(!t){t=i;i={}}walk(e,i,(function(n,r){if(n)throw n;var fileWatcher=function(e){var n={};i.interval&&(n.interval=1e3*i.interval);f.watchFile(e,n,(function(n,l){if(!r[e]||r[e].isDirectory()||0===n.nlink||r[e].mtime.getTime()!=n.mtime.getTime()){r[e]=n;r[e].isDirectory()?f.readdir(e,(function(n,l){n||l.forEach((function(n){var l=a.join(e,n);r[l]||true===i.ignoreDotFiles&&"."==n[0]||f.stat(l,(function(e,n){if(!i.filter||i.filter(l,n)){t(l,n,null);r[l]=n;fileWatcher(l)}}))}))})):t(e,n,l);if(0===n.nlink){delete r[e];f.unwatchFile(e)}}}))};fileWatcher(e);for(var l in r)fileWatcher(l);c[e]=r;t(r,null,null)}))};r.unwatchTree=function(e){if(c[e]){Object.keys(c[e]).forEach(f.unwatchFile);c[e]=false}};r.createMonitor=function(e,i,t){if(!t){t=i;i={}}var n=new o.EventEmitter;n.stop=r.unwatchTree.bind(null,e);var l={file:null,action:null,stat:null};r.watchTree(e,i,(function(e,i,r){if("object"==typeof e&&null==r&&null===i){n.files=e;return t(n)}if(!r&&(l.file!=e||"created"!=l.action)){l={file:e,action:"created",stat:i};return n.emit("created",e,i)}if(i&&0===i.nlink&&(l.file!=e||"removed"!=l.action)){l={file:e,action:"removed",stat:i};return n.emit("removed",e,i)}if(null===l.file)return n.emit("changed",e,i,r);try{if(l.stat.mtime.getTime()!==i.mtime.getTime())return n.emit("changed",e,i,r)}catch(t){return n.emit("changed",e,i,r)}}))};r.walk=walk;const u=r.watchTree,s=r.unwatchTree,d=r.createMonitor;const m=r.walk;export default r;export{d as createMonitor,s as unwatchTree,m as walk,u as watchTree};

