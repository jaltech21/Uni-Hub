// socket.io@0.9.19 downloaded from https://ga.jspm.io/npm:socket.io@0.9.19/index.js

import e from"socket.io-client";import t from"https";import r from"http";import o from"fs";import n from"url";import i from"tty";import s from"crypto";import{e as a}from"./_/ccc9ed74.js";import c from"events";import{_ as h,a as l}from"./_/5f57053f.js";import{e as p,_ as f}from"./_/58260865.js";import u from"buffer";import d from"policyfile";import g from"querystring";import m from"./lib/logger.js";import y from"./lib/namespace.js";import v from"child_process";import b from"process";import"assert";import"msgpack";import"redis";var k="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var w={};var T=p;w=w=Transport;function Transport(e,t,r){(this||k).manager=e;(this||k).id=t.id;(this||k).disconnected=false;(this||k).drained=true;this.handleRequest(r)}Transport.prototype.__defineGetter__("log",(function(){return(this||k).manager.log}));Transport.prototype.__defineGetter__("store",(function(){return(this||k).manager.store}));Transport.prototype.handleRequest=function(e){(this||k).log.debug("setting request",e.method,e.url);(this||k).req=e;if("GET"==e.method){(this||k).socket=e.socket;(this||k).open=true;(this||k).drained=true;this.setHeartbeatInterval();this.setHandlers();this.onSocketConnect()}};Transport.prototype.onSocketConnect=function(){};Transport.prototype.setHandlers=function(){var e=this||k;(this||k).bound={end:(this||k).onSocketEnd.bind(this||k),close:(this||k).onSocketClose.bind(this||k),error:(this||k).onSocketError.bind(this||k),drain:(this||k).onSocketDrain.bind(this||k)};(this||k).socket.on("end",(this||k).bound.end);(this||k).socket.on("close",(this||k).bound.close);(this||k).socket.on("error",(this||k).bound.error);(this||k).socket.on("drain",(this||k).bound.drain);(this||k).handlersSet=true};Transport.prototype.clearHandlers=function(){if((this||k).handlersSet){(this||k).socket.removeListener("end",(this||k).bound.end);(this||k).socket.removeListener("close",(this||k).bound.close);(this||k).socket.removeListener("error",(this||k).bound.error);(this||k).socket.removeListener("drain",(this||k).bound.drain)}};Transport.prototype.onSocketEnd=function(){this.end("socket end")};Transport.prototype.onSocketClose=function(e){this.end(e?"socket error":"socket close")};Transport.prototype.onSocketError=function(e){if((this||k).open){(this||k).socket.destroy();this.onClose()}(this||k).log.info("socket error "+e.stack)};Transport.prototype.onSocketDrain=function(){(this||k).drained=true};Transport.prototype.onHeartbeatClear=function(){this.clearHeartbeatTimeout();this.setHeartbeatInterval()};Transport.prototype.onForcedDisconnect=function(){if(!(this||k).disconnected){(this||k).log.info("transport end by forced client disconnection");(this||k).open&&this.packet({type:"disconnect"});this.end("booted")}};Transport.prototype.onDispatch=function(e,t){t?this.writeVolatile(e):this.write(e)};Transport.prototype.setCloseTimeout=function(){if(!(this||k).closeTimeout){var e=this||k;(this||k).closeTimeout=setTimeout((function(){e.log.debug("fired close timeout for client",e.id);e.closeTimeout=null;e.end("close timeout")}),1e3*(this||k).manager.get("close timeout"));(this||k).log.debug("set close timeout for client",(this||k).id)}};Transport.prototype.clearCloseTimeout=function(){if((this||k).closeTimeout){clearTimeout((this||k).closeTimeout);(this||k).closeTimeout=null;(this||k).log.debug("cleared close timeout for client",(this||k).id)}};Transport.prototype.setHeartbeatTimeout=function(){if(!(this||k).heartbeatTimeout&&(this||k).manager.enabled("heartbeats")){var e=this||k;(this||k).heartbeatTimeout=setTimeout((function(){e.log.debug("fired heartbeat timeout for client",e.id);e.heartbeatTimeout=null;e.end("heartbeat timeout")}),1e3*(this||k).manager.get("heartbeat timeout"));(this||k).log.debug("set heartbeat timeout for client",(this||k).id)}};Transport.prototype.clearHeartbeatTimeout=function(){if((this||k).heartbeatTimeout&&(this||k).manager.enabled("heartbeats")){clearTimeout((this||k).heartbeatTimeout);(this||k).heartbeatTimeout=null;(this||k).log.debug("cleared heartbeat timeout for client",(this||k).id)}};Transport.prototype.setHeartbeatInterval=function(){if(!(this||k).heartbeatInterval&&(this||k).manager.enabled("heartbeats")){var e=this||k;(this||k).heartbeatInterval=setTimeout((function(){e.heartbeat();e.heartbeatInterval=null}),1e3*(this||k).manager.get("heartbeat interval"));(this||k).log.debug("set heartbeat interval for client",(this||k).id)}};Transport.prototype.clearTimeouts=function(){this.clearCloseTimeout();this.clearHeartbeatTimeout();this.clearHeartbeatInterval()};Transport.prototype.heartbeat=function(){if((this||k).open){(this||k).log.debug("emitting heartbeat for client",(this||k).id);this.packet({type:"heartbeat"});this.setHeartbeatTimeout()}return this||k};Transport.prototype.onMessage=function(e){var t=(this||k).manager.transports[(this||k).id];if("heartbeat"==e.type){(this||k).log.debug("got heartbeat packet");t&&t.open?t.onHeartbeatClear():(this||k).store.publish("heartbeat-clear",(this||k).id)}else{if("disconnect"==e.type&&""==e.endpoint){(this||k).log.debug("got disconnection packet");t?t.onForcedDisconnect():(this||k).store.publish("disconnect-force",(this||k).id);return}if(e.id&&"data"!=e.ack){(this||k).log.debug("acknowledging packet automatically");var r=T.encodePacket({type:"ack",ackId:e.id,endpoint:e.endpoint||""});if(t&&t.open)t.onDispatch(r);else{(this||k).manager.onClientDispatch((this||k).id,r);(this||k).store.publish("dispatch-remote",(this||k).id,r)}}t?(this||k).manager.onClientMessage((this||k).id,e):(this||k).store.publish("message-remote",(this||k).id,e)}};Transport.prototype.clearHeartbeatInterval=function(){if((this||k).heartbeatInterval&&(this||k).manager.enabled("heartbeats")){clearTimeout((this||k).heartbeatInterval);(this||k).heartbeatInterval=null;(this||k).log.debug("cleared heartbeat interval for client",(this||k).id)}};Transport.prototype.disconnect=function(e){this.packet({type:"disconnect"});this.end(e);return this||k};Transport.prototype.close=function(){if((this||k).open){this.doClose();this.onClose()}};Transport.prototype.onClose=function(){if((this||k).open){this.setCloseTimeout();this.clearHandlers();(this||k).open=false;(this||k).manager.onClose((this||k).id);(this||k).store.publish("close",(this||k).id)}};Transport.prototype.end=function(e){if(!(this||k).disconnected){(this||k).log.info("transport end ("+e+")");var t=(this||k).manager.transports[(this||k).id];this.close();this.clearTimeouts();(this||k).disconnected=true;t&&(this||k).manager.onClientDisconnect((this||k).id,e);(this||k).store.publish("disconnect-remote",(this||k).id,e)}};Transport.prototype.discard=function(){(this||k).log.debug("discarding transport");(this||k).discarded=true;this.clearTimeouts();this.clearHandlers();return this||k};Transport.prototype.error=function(e,t){this.packet({type:"error",reason:e,advice:t});(this||k).log.warn(e,t?"client should "+t:"");this.end("error")};Transport.prototype.packet=function(e){return this.write(T.encodePacket(e))};Transport.prototype.writeVolatile=function(e){(this||k).open?(this||k).drained?this.write(e):(this||k).log.debug("ignoring volatile packet, buffer not drained"):(this||k).log.debug("ignoring volatile packet, transport not open")};var x=w;var P="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var S={};var C=u.Buffer;var M=x,_=c.EventEmitter,O=s,H=n,q=p,D=a;S=S=WebSocket;S.Parser=Parser;function WebSocket(e,t,r){var o=this||P;(this||P).manager=e;(this||P).parser=new Parser({maxBuffer:e.get("destroy buffer size")});(this||P).parser.on("data",(function(e){o.onMessage(q.decodePacket(e))}));(this||P).parser.on("ping",(function(){try{o.socket.write("\0")}catch(e){o.end();return}}));(this||P).parser.on("close",(function(){o.end()}));(this||P).parser.on("error",(function(e){o.log.warn(o.name+" parser error: "+e);o.end()}));(this||P).parser.on("kick",(function(e){o.log.warn(o.name+" parser forced user kick: "+e);o.onMessage({type:"disconnect",endpoint:""});o.end()}));M.call(this||P,e,t,r)}WebSocket.prototype.__proto__=M.prototype;WebSocket.prototype.name="websocket";WebSocket.prototype.protocolVersion="07-12";WebSocket.prototype.onSocketConnect=function(){var e=this||P;if("undefined"!==typeof(this||P).req.headers.upgrade&&"websocket"===(this||P).req.headers.upgrade.toLowerCase()){var t=(this||P).req.headers["sec-websocket-origin"],r=(((this||P).manager.settings["match origin protocol"]?t.match(/^https/):(this||P).socket.encrypted)?"wss":"ws")+"://"+(this||P).req.headers.host+(this||P).req.url;if(this.verifyOrigin(t))if((this||P).req.headers["sec-websocket-key"]){var o=(this||P).req.headers["sec-websocket-key"];var n=O.createHash("sha1");n.update(o+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11");o=n.digest("base64");var i=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+o];try{(this||P).socket.write(i.concat("","").join("\r\n"));(this||P).socket.setTimeout(0);(this||P).socket.setNoDelay(true)}catch(e){this.end();return}(this||P).socket.on("data",(function(t){e.parser.add(t)}))}else{(this||P).log.warn((this||P).name+" connection invalid: received no key");this.end()}else{(this||P).log.warn((this||P).name+" connection invalid: origin mismatch");this.end()}}else{(this||P).log.warn((this||P).name+" connection invalid");this.end()}};WebSocket.prototype.verifyOrigin=function(e){var t=(this||P).manager.get("origins");"null"===e&&(e="*");if(-1!==t.indexOf("*:*"))return true;if(e)try{var r=H.parse(e);r.port=r.port||80;var o=~t.indexOf(r.hostname+":"+r.port)||~t.indexOf(r.hostname+":*")||~t.indexOf("*:"+r.port);o||(this||P).log.warn("illegal origin: "+e);return o}catch(e){(this||P).log.warn("error parsing origin")}else(this||P).log.warn("origin missing from websocket call, yet required by config");return false};WebSocket.prototype.write=function(e){if((this||P).open){var t=this.frame(129,e);try{(this||P).socket.write(t,"binary")}catch(e){this.end();return}(this||P).log.debug((this||P).name+" writing",e)}};WebSocket.prototype.payload=function(e){for(var t=0,r=e.length;t<r;t++)this.write(e[t]);return this||P};WebSocket.prototype.frame=function(e,t){var r=new C(t),o=r.length,n=2,i=o;if(o>65536){n=10;i=127}else if(o>125){n=4;i=126}var s=new C(o+n);s[0]=e;s[1]=i;r.copy(s,n);switch(i){case 126:s[2]=o>>>8;s[3]=o%256;break;case 127:var a=o;for(var c=1;c<=8;++c){s[n-c]=255&a;a>>>=8}}return s};WebSocket.prototype.doClose=function(){(this||P).socket.end()};function Parser(e){(this||P).state={activeFragmentedOperation:null,lastFragment:false,masked:false,opcode:0};(this||P).overflow=null;(this||P).expectOffset=0;(this||P).expectBuffer=null;(this||P).expectHandler=null;(this||P).currentMessage="";(this||P)._maxBuffer=e&&e.maxBuffer||1e8;(this||P)._dataLength=0;var t=this||P;(this||P).opcodeHandlers={1:function(e){var finish=function(e,r){t.currentMessage+=t.unmask(e,r);if(t.state.lastFragment){t.emit("data",t.currentMessage);t.currentMessage=""}t.endPacket()};var expectData=function(e){t.state.masked?t.expect("Mask",4,(function(r){var o=r;t.expect("Data",e,(function(e){finish(o,e)}))})):t.expect("Data",e,(function(e){finish(null,e)}))};var r=127&e[1];r<126?expectData(r):126==r?t.expect("Length",2,(function(e){expectData(D.unpack(e))})):127==r&&t.expect("Length",8,(function(e){if(0==D.unpack(e.slice(0,4))){var r=e.slice(4);expectData(D.unpack(e))}else t.error("packets with length spanning more than 32 bit is currently not supported")}))},2:function(e){var finish=function(e,r){"string"==typeof t.currentMessage&&(t.currentMessage=[]);t.currentMessage.push(t.unmask(e,r,true));if(t.state.lastFragment){t.emit("binary",t.concatBuffers(t.currentMessage));t.currentMessage=""}t.endPacket()};var expectData=function(e){t.state.masked?t.expect("Mask",4,(function(r){var o=r;t.expect("Data",e,(function(e){finish(o,e)}))})):t.expect("Data",e,(function(e){finish(null,e)}))};var r=127&e[1];r<126?expectData(r):126==r?t.expect("Length",2,(function(e){expectData(D.unpack(e))})):127==r&&t.expect("Length",8,(function(e){if(0==D.unpack(e.slice(0,4))){var r=e.slice(4);expectData(D.unpack(e))}else t.error("packets with length spanning more than 32 bit is currently not supported")}))},8:function(e){t.emit("close");t.reset()},9:function(e){if(false!=t.state.lastFragment){var finish=function(e,r){t.emit("ping",t.unmask(e,r));t.endPacket()};var expectData=function(e){t.state.masked?t.expect("Mask",4,(function(r){var o=r;t.expect("Data",e,(function(e){finish(o,e)}))})):t.expect("Data",e,(function(e){finish(null,e)}))};var r=127&e[1];0==r?finish(null,null):r<126?expectData(r):126==r?t.expect("Length",2,(function(e){expectData(D.unpack(e))})):127==r&&t.expect("Length",8,(function(e){expectData(D.unpack(e))}))}else t.error("fragmented ping is not supported")}};this.expect("Opcode",2,(this||P).processPacket)}Parser.prototype.__proto__=_.prototype;Parser.prototype.add=function(e){(this||P)._dataLength+=e.length;if((this||P)._dataLength>(this||P)._maxBuffer){(this||P).overflow=null;(this||P).expectBuffer=null;this.emit("kick","max buffer size reached")}else if(null!=(this||P).expectBuffer){var t=Math.min(e.length,(this||P).expectBuffer.length-(this||P).expectOffset);e.copy((this||P).expectBuffer,(this||P).expectOffset,0,t);(this||P).expectOffset+=t;if(t<e.length){(this||P).overflow=new C(e.length-t);e.copy((this||P).overflow,0,t,t+(this||P).overflow.length)}if((this||P).expectOffset==(this||P).expectBuffer.length){var r=(this||P).expectBuffer;(this||P).expectBuffer=null;(this||P).expectOffset=0;(this||P).expectHandler.call(this||P,r)}}else this.addToOverflow(e)};Parser.prototype.addToOverflow=function(e){if(null==(this||P).overflow)(this||P).overflow=e;else{var t=(this||P).overflow;(this||P).overflow=new C((this||P).overflow.length+e.length);t.copy((this||P).overflow,0);e.copy((this||P).overflow,t.length)}};Parser.prototype.expect=function(e,t,r){if(t>(this||P)._maxBuffer)this.emit("kick","expected input larger than max buffer");else{(this||P).expectBuffer=new C(t);(this||P).expectOffset=0;(this||P).expectHandler=r;if(null!=(this||P).overflow){var o=(this||P).overflow;(this||P).overflow=null;this.add(o)}}};Parser.prototype.processPacket=function(e){0!=(112&e[0])&&this.error("reserved fields must be empty");(this||P).state.lastFragment=128==(128&e[0]);(this||P).state.masked=128==(128&e[1]);var t=15&e[0];if(0==t){(this||P).state.opcode=(this||P).state.activeFragmentedOperation;if(!(1==(this||P).state.opcode||2==(this||P).state.opcode)){this.error("continuation frame cannot follow current opcode");return}}else{(this||P).state.opcode=t;false===(this||P).state.lastFragment&&((this||P).state.activeFragmentedOperation=t)}var r=(this||P).opcodeHandlers[(this||P).state.opcode];"undefined"==typeof r?this.error("no handler for opcode "+(this||P).state.opcode):r(e)};Parser.prototype.endPacket=function(){(this||P).expectOffset=0;(this||P).expectBuffer=null;(this||P).expectHandler=null;(this||P).state.lastFragment&&(this||P).state.opcode==(this||P).state.activeFragmentedOperation&&((this||P).state.activeFragmentedOperation=null);(this||P).state.lastFragment=false;(this||P).state.opcode=null!=(this||P).state.activeFragmentedOperation?(this||P).state.activeFragmentedOperation:0;(this||P).state.masked=false;this.expect("Opcode",2,(this||P).processPacket)};Parser.prototype.reset=function(){(this||P).state={activeFragmentedOperation:null,lastFragment:false,masked:false,opcode:0};(this||P).expectOffset=0;(this||P).expectBuffer=null;(this||P).expectHandler=null;(this||P).overflow=null;(this||P).currentMessage=""};Parser.prototype.unmask=function(e,t,r){if(null!=e)for(var o=0,n=t.length;o<n;o++)t[o]^=e[o%4];return r?t:null!=t?t.toString("utf8"):""};Parser.prototype.concatBuffers=function(e){var t=0;for(var r=0,o=e.length;r<o;++r)t+=e[r].length;var n=new C(t);var i=0;for(var r=0,o=e.length;r<o;++r){e[r].copy(n,i);i+=e[r].length}return n};Parser.prototype.error=function(e){this.reset();this.emit("error",e);return this||P};var B=S;var W="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var F={};var L=u.Buffer;var $=x,E=c.EventEmitter,j=s,A=n,z=p,I=a;F=F=WebSocket$1;F.Parser=Parser$1;function WebSocket$1(e,t,r){var o=this||W;(this||W).manager=e;(this||W).parser=new Parser$1({maxBuffer:e.get("destroy buffer size")});(this||W).parser.on("data",(function(e){o.onMessage(z.decodePacket(e))}));(this||W).parser.on("ping",(function(){try{o.socket.write("\0")}catch(e){o.end();return}}));(this||W).parser.on("close",(function(){o.end()}));(this||W).parser.on("error",(function(e){o.log.warn(o.name+" parser error: "+e);o.end()}));(this||W).parser.on("kick",(function(e){o.log.warn(o.name+" parser forced user kick: "+e);o.onMessage({type:"disconnect",endpoint:""});o.end()}));$.call(this||W,e,t,r)}WebSocket$1.prototype.__proto__=$.prototype;WebSocket$1.prototype.name="websocket";WebSocket$1.prototype.protocolVersion="16";WebSocket$1.prototype.onSocketConnect=function(){var e=this||W;if("undefined"!==typeof(this||W).req.headers.upgrade&&"websocket"===(this||W).req.headers.upgrade.toLowerCase()){var t=(this||W).req.headers["origin"]||"",r=(((this||W).manager.settings["match origin protocol"]?t.match(/^https/):(this||W).socket.encrypted)?"wss":"ws")+"://"+(this||W).req.headers.host+(this||W).req.url;if(this.verifyOrigin(t))if((this||W).req.headers["sec-websocket-key"]){var o=(this||W).req.headers["sec-websocket-key"];var n=j.createHash("sha1");n.update(o+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11");o=n.digest("base64");var i=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+o];try{(this||W).socket.write(i.concat("","").join("\r\n"));(this||W).socket.setTimeout(0);(this||W).socket.setNoDelay(true)}catch(e){this.end();return}(this||W).socket.on("data",(function(t){e.parser.add(t)}))}else{(this||W).log.warn((this||W).name+" connection invalid: received no key");this.end()}else{(this||W).log.warn((this||W).name+" connection invalid: origin mismatch");this.end()}}else{(this||W).log.warn((this||W).name+" connection invalid");this.end()}};WebSocket$1.prototype.verifyOrigin=function(e){var t=(this||W).manager.get("origins");"null"===e&&(e="*");if(-1!==t.indexOf("*:*"))return true;if(e)try{var r=A.parse(e);r.port=r.port||80;var o=~t.indexOf(r.hostname+":"+r.port)||~t.indexOf(r.hostname+":*")||~t.indexOf("*:"+r.port);o||(this||W).log.warn("illegal origin: "+e);return o}catch(e){(this||W).log.warn("error parsing origin")}else(this||W).log.warn("origin missing from websocket call, yet required by config");return false};WebSocket$1.prototype.write=function(e){if((this||W).open){var t=this.frame(129,e);try{(this||W).socket.write(t,"binary")}catch(e){this.end();return}(this||W).log.debug((this||W).name+" writing",e)}};WebSocket$1.prototype.payload=function(e){for(var t=0,r=e.length;t<r;t++)this.write(e[t]);return this||W};WebSocket$1.prototype.frame=function(e,t){var r=new L(t),o=r.length,n=2,i=o;if(o>65536){n=10;i=127}else if(o>125){n=4;i=126}var s=new L(o+n);s[0]=e;s[1]=i;r.copy(s,n);switch(i){case 126:s[2]=o>>>8;s[3]=o%256;break;case 127:var a=o;for(var c=1;c<=8;++c){s[n-c]=255&a;a>>>=8}}return s};WebSocket$1.prototype.doClose=function(){(this||W).socket.end()};function Parser$1(e){(this||W).state={activeFragmentedOperation:null,lastFragment:false,masked:false,opcode:0};(this||W).overflow=null;(this||W).expectOffset=0;(this||W).expectBuffer=null;(this||W).expectHandler=null;(this||W).currentMessage="";(this||W)._maxBuffer=e&&e.maxBuffer||1e8;(this||W)._dataLength=0;var t=this||W;(this||W).opcodeHandlers={1:function(e){var finish=function(e,r){t.currentMessage+=t.unmask(e,r);if(t.state.lastFragment){t.emit("data",t.currentMessage);t.currentMessage=""}t.endPacket()};var expectData=function(e){t.state.masked?t.expect("Mask",4,(function(r){var o=r;t.expect("Data",e,(function(e){finish(o,e)}))})):t.expect("Data",e,(function(e){finish(null,e)}))};var r=127&e[1];r<126?expectData(r):126==r?t.expect("Length",2,(function(e){expectData(I.unpack(e))})):127==r&&t.expect("Length",8,(function(e){if(0==I.unpack(e.slice(0,4))){var r=e.slice(4);expectData(I.unpack(e))}else t.error("packets with length spanning more than 32 bit is currently not supported")}))},2:function(e){var finish=function(e,r){"string"==typeof t.currentMessage&&(t.currentMessage=[]);t.currentMessage.push(t.unmask(e,r,true));if(t.state.lastFragment){t.emit("binary",t.concatBuffers(t.currentMessage));t.currentMessage=""}t.endPacket()};var expectData=function(e){t.state.masked?t.expect("Mask",4,(function(r){var o=r;t.expect("Data",e,(function(e){finish(o,e)}))})):t.expect("Data",e,(function(e){finish(null,e)}))};var r=127&e[1];r<126?expectData(r):126==r?t.expect("Length",2,(function(e){expectData(I.unpack(e))})):127==r&&t.expect("Length",8,(function(e){if(0==I.unpack(e.slice(0,4))){var r=e.slice(4);expectData(I.unpack(e))}else t.error("packets with length spanning more than 32 bit is currently not supported")}))},8:function(e){t.emit("close");t.reset()},9:function(e){if(false!=t.state.lastFragment){var finish=function(e,r){t.emit("ping",t.unmask(e,r));t.endPacket()};var expectData=function(e){t.state.masked?t.expect("Mask",4,(function(r){var o=r;t.expect("Data",e,(function(e){finish(o,e)}))})):t.expect("Data",e,(function(e){finish(null,e)}))};var r=127&e[1];0==r?finish(null,null):r<126?expectData(r):126==r?t.expect("Length",2,(function(e){expectData(I.unpack(e))})):127==r&&t.expect("Length",8,(function(e){expectData(I.unpack(e))}))}else t.error("fragmented ping is not supported")}};this.expect("Opcode",2,(this||W).processPacket)}Parser$1.prototype.__proto__=E.prototype;Parser$1.prototype.add=function(e){(this||W)._dataLength+=e.length;if((this||W)._dataLength>(this||W)._maxBuffer){(this||W).overflow=null;(this||W).expectBuffer=null;this.emit("kick","max buffer size reached")}else if(null!=(this||W).expectBuffer){var t=Math.min(e.length,(this||W).expectBuffer.length-(this||W).expectOffset);e.copy((this||W).expectBuffer,(this||W).expectOffset,0,t);(this||W).expectOffset+=t;if(t<e.length){(this||W).overflow=new L(e.length-t);e.copy((this||W).overflow,0,t,t+(this||W).overflow.length)}if((this||W).expectOffset==(this||W).expectBuffer.length){var r=(this||W).expectBuffer;(this||W).expectBuffer=null;(this||W).expectOffset=0;(this||W).expectHandler.call(this||W,r)}}else this.addToOverflow(e)};Parser$1.prototype.addToOverflow=function(e){if(null==(this||W).overflow)(this||W).overflow=e;else{var t=(this||W).overflow;(this||W).overflow=new L((this||W).overflow.length+e.length);t.copy((this||W).overflow,0);e.copy((this||W).overflow,t.length)}};Parser$1.prototype.expect=function(e,t,r){if(t>(this||W)._maxBuffer)this.emit("kick","expected input larger than max buffer");else{(this||W).expectBuffer=new L(t);(this||W).expectOffset=0;(this||W).expectHandler=r;if(null!=(this||W).overflow){var o=(this||W).overflow;(this||W).overflow=null;this.add(o)}}};Parser$1.prototype.processPacket=function(e){if(0==(112&e[0])){(this||W).state.lastFragment=128==(128&e[0]);(this||W).state.masked=128==(128&e[1]);var t=15&e[0];if(0==t){(this||W).state.opcode=(this||W).state.activeFragmentedOperation;if(!(1==(this||W).state.opcode||2==(this||W).state.opcode)){this.error("continuation frame cannot follow current opcode");return}}else{(this||W).state.opcode=t;false===(this||W).state.lastFragment&&((this||W).state.activeFragmentedOperation=t)}var r=(this||W).opcodeHandlers[(this||W).state.opcode];"undefined"==typeof r?this.error("no handler for opcode "+(this||W).state.opcode):r(e)}else this.error("reserved fields must be empty")};Parser$1.prototype.endPacket=function(){(this||W).expectOffset=0;(this||W).expectBuffer=null;(this||W).expectHandler=null;(this||W).state.lastFragment&&(this||W).state.opcode==(this||W).state.activeFragmentedOperation&&((this||W).state.activeFragmentedOperation=null);(this||W).state.lastFragment=false;(this||W).state.opcode=null!=(this||W).state.activeFragmentedOperation?(this||W).state.activeFragmentedOperation:0;(this||W).state.masked=false;this.expect("Opcode",2,(this||W).processPacket)};Parser$1.prototype.reset=function(){(this||W).state={activeFragmentedOperation:null,lastFragment:false,masked:false,opcode:0};(this||W).expectOffset=0;(this||W).expectBuffer=null;(this||W).expectHandler=null;(this||W).overflow=null;(this||W).currentMessage=""};Parser$1.prototype.unmask=function(e,t,r){if(null!=e)for(var o=0,n=t.length;o<n;o++)t[o]^=e[o%4];return r?t:null!=t?t.toString("utf8"):""};Parser$1.prototype.concatBuffers=function(e){var t=0;for(var r=0,o=e.length;r<o;++r)t+=e[r].length;var n=new L(t);var i=0;for(var r=0,o=e.length;r<o;++r){e[r].copy(n,i);i+=e[r].length}return n};Parser$1.prototype.error=function(e){this.reset();this.emit("error",e);return this||W};var R=F;var N;var U="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var J={};var X=u.Buffer;var G=x,V=c.EventEmitter,K=s,Q=p;J=J=WebSocket$2;function WebSocket$2(e,t,r){var o=this||U;(this||U).parser=new Parser$2({maxBuffer:e.get("destroy buffer size")});(this||U).parser.on("data",(function(e){o.log.debug(o.name+" received data packet",e);o.onMessage(Q.decodePacket(e))}));(this||U).parser.on("close",(function(){o.end()}));(this||U).parser.on("error",(function(){o.end()}));(this||U).parser.on("kick",(function(e){o.log.warn(o.name+" parser forced user kick: "+e);o.onMessage({type:"disconnect",endpoint:""});o.end()}));G.call(this||U,e,t,r)}WebSocket$2.prototype.__proto__=G.prototype;WebSocket$2.prototype.name="websocket";WebSocket$2.prototype.protocolVersion="hixie-76";WebSocket$2.prototype.onSocketConnect=function(){var e=this||U;(this||U).socket.setNoDelay(true);(this||U).buffer=true;(this||U).buffered=[];if("WebSocket"===(this||U).req.headers.upgrade){var t=(this||U).req.headers["origin"],r=false;(this||U).manager.settings["match origin protocol"]?U.location=N=(t.indexOf("https")>-1?"wss":"ws")+"://"+(this||U).req.headers.host+(this||U).req.url:N=(this||U).socket.encrypted?"wss://"+(this||U).req.headers.host+(this||U).req.url:"ws://"+(this||U).req.headers.host+(this||U).req.url;if((this||U).req.headers["sec-websocket-key1"]){(this||U).req.head&&(this||U).req.head.length>=8||(r=true);var o=["HTTP/1.1 101 WebSocket Protocol Handshake","Upgrade: WebSocket","Connection: Upgrade","Sec-WebSocket-Origin: "+t,"Sec-WebSocket-Location: "+N];(this||U).req.headers["sec-websocket-protocol"]&&o.push("Sec-WebSocket-Protocol: "+(this||U).req.headers["sec-websocket-protocol"])}else var o=["HTTP/1.1 101 Web Socket Protocol Handshake","Upgrade: WebSocket","Connection: Upgrade","WebSocket-Origin: "+t,"WebSocket-Location: "+N];try{(this||U).socket.write(o.concat("","").join("\r\n"));(this||U).socket.setTimeout(0);(this||U).socket.setNoDelay(true);(this||U).socket.setEncoding("utf8")}catch(e){this.end();return}r?(this||U).socket.setEncoding("binary"):this.proveReception(o)&&e.flush();var n="";(this||U).socket.on("data",(function(t){if(r){n+=t;if(n.length<8)return;e.socket.setEncoding("utf8");r=false;e.req.head=n.substr(0,8);n="";e.proveReception(o)&&e.flush()}else e.parser.add(t)}))}else{(this||U).log.warn((this||U).name+" connection invalid");this.end()}};WebSocket$2.prototype.write=function(e){if((this||U).open){(this||U).drained=false;if((this||U).buffer){(this||U).buffered.push(e);return this||U}var t=X.byteLength(e),r=new X(2+t);r.write("\0","binary");r.write(e,1,"utf8");r.write("ÿ",1+t,"binary");try{(this||U).socket.write(r)&&((this||U).drained=true)}catch(e){this.end()}(this||U).log.debug((this||U).name+" writing",e)}};WebSocket$2.prototype.flush=function(){(this||U).buffer=false;for(var e=0,t=(this||U).buffered.length;e<t;e++)this.write((this||U).buffered.splice(0,1)[0])};WebSocket$2.prototype.proveReception=function(e){var t=this||U,r=(this||U).req.headers["sec-websocket-key1"],o=(this||U).req.headers["sec-websocket-key2"];if(r&&o){var n=K.createHash("md5");[r,o].forEach((function(e){var r=parseInt(e.replace(/[^\d]/g,"")),o=e.replace(/[^ ]/g,"").length;if(0===o||r%o!==0){t.log.warn("Invalid "+t.name+' key: "'+e+'".');t.end();return false}r/=o;n.update(String.fromCharCode(r>>24&255,r>>16&255,r>>8&255,255&r))}));n.update((this||U).req.head.toString("binary"));try{(this||U).socket.write(n.digest("binary"),"binary")}catch(e){this.end()}}return true};WebSocket$2.prototype.payload=function(e){for(var t=0,r=e.length;t<r;t++)this.write(e[t]);return this||U};WebSocket$2.prototype.doClose=function(){(this||U).socket.end()};function Parser$2(e){(this||U)._maxBuffer=e&&e.maxBuffer||1e8;(this||U)._dataLength=0;(this||U).buffer="";(this||U).i=0}Parser$2.prototype.__proto__=V.prototype;Parser$2.prototype.add=function(e){(this||U)._dataLength+=e.length;if((this||U)._dataLength>(this||U)._maxBuffer){(this||U).buffer="";this.emit("kick","max buffer size reached")}else{(this||U).buffer+=e;this.parse()}};Parser$2.prototype.parse=function(){for(var e=(this||U).i,t,r=(this||U).buffer.length;e<r;e++){t=(this||U).buffer[e];if(2==(this||U).buffer.length&&"\0"==(this||U).buffer[1]){this.emit("close");(this||U).buffer="";(this||U).i=0;return}if(0===e){if("\0"==t)continue;this.error("Bad framing. Expected null byte as first frame")}if("�"==t){this.emit("data",(this||U).buffer.substr(1,e-1));(this||U).buffer=(this||U).buffer.substr(e+1);(this||U).i=0;return this.parse()}}};Parser$2.prototype.error=function(e){(this||U).buffer="";(this||U).i=0;this.emit("error",e);return this||U};var Y=J;var Z={};Z={7:B,8:B,13:R,default:Y};var ee=Z;var te="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var re={};var oe=ee;re=re=WebSocket$3;function WebSocket$3(e,t,r){var o,n=r.headers["sec-websocket-version"];o="undefined"!==typeof n&&"undefined"!==typeof oe[n]?new oe[n](e,t,r):new oe["default"](e,t,r);"undefined"!==typeof(this||te).name&&(o.name=(this||te).name);return o}var ne=re;var ie="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var se={};var ae=ne;se=se=FlashSocket;function FlashSocket(e,t,r){return ae.call(this||ie,e,t,r)}FlashSocket.prototype.__proto__=ae.prototype;FlashSocket.prototype.name="flashsocket";FlashSocket.init=function(e){var t;function create(){if(e.get("flash policy server")){t=d.createServer({log:function(t){e.log.info(t)}},e.get("origins"));t.on("close",(function(e){t=null}));t.listen(e.get("flash policy port"),e.server);e.flashPolicyServer=t}}e.on("set:origins",(function(e,r){if(t){t.origins=Array.isArray(e)?e:[e];t.compile()}}));e.on("set:flash policy port",(function(r,o){var n=e.get("transports");if(~n.indexOf("flashsocket")){if(t){if(t.port===r)return;try{t.close()}catch(e){}}create()}}));e.on("set:flash policy server",(function(r,o){var n=e.get("transports");if(~n.indexOf("flashsocket")){if(t&&!r)try{t.close()}catch(e){}}else!t&&r&&create()}));e.on("set:transports",(function(r,o){!t&&~e.get("transports").indexOf("flashsocket")&&create()}));~e.get("transports").indexOf("flashsocket")&&create()};var ce=se;var he="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var le={};var pe=u.Buffer;var fe=x,ue=p,de=g;le=le=HTTPTransport;function HTTPTransport(e,t,r){fe.call(this||he,e,t,r)}HTTPTransport.prototype.__proto__=fe.prototype;HTTPTransport.prototype.handleRequest=function(e){(this||he).response=e.res;if("POST"==e.method){var t="",r=e.res,o=e.headers.origin,n={"Content-Length":1,"Content-Type":"text/plain; charset=UTF-8"},i=this||he;e.on("data",(function(r){t+=r;if(pe.byteLength(t)>=i.manager.get("destroy buffer size")){t="";e.connection.destroy()}}));e.on("end",(function(){r.writeHead(200,n);r.end("1");i.onData(i.postEncoded?de.parse(t).d:t)}));e.on("close",(function(){t="";i.onClose()}));if(o){n["Access-Control-Allow-Origin"]=o;n["Access-Control-Allow-Credentials"]="true";n["X-XSS-Protection"]="0"}}else fe.prototype.handleRequest.call(this||he,e)};HTTPTransport.prototype.onData=function(e){var t=ue.decodePayload(e);(this||he).log.debug((this||he).name+" received data packet",e);for(var r=0,o=t.length;r<o;r++)this.onMessage(t[r])};HTTPTransport.prototype.doClose=function(){(this||he).response.end()};HTTPTransport.prototype.payload=function(e){this.write(ue.encodePayload(e))};var ge=le;var me="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var ye={};var ve=ge;ye=ye=HTMLFile;function HTMLFile(e,t,r){ve.call(this||me,e,t,r)}HTMLFile.prototype.__proto__=ve.prototype;HTMLFile.prototype.name="htmlfile";HTMLFile.prototype.handleRequest=function(e){ve.prototype.handleRequest.call(this||me,e);if("GET"==e.method){e.res.writeHead(200,{"Content-Type":"text/html; charset=UTF-8",Connection:"keep-alive","Transfer-Encoding":"chunked"});e.res.write("<html><body>"+"<script>var _ = function (msg) { parent.s._(msg, document); };<\/script>"+new Array(174).join(" "))}};HTMLFile.prototype.write=function(e){e="<script>_("+JSON.stringify(e).replace(/\//g,"\\/")+");<\/script>";(this||me).response.write(e)&&((this||me).drained=true);(this||me).log.debug((this||me).name+" writing",e)};var be=ye;var ke="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var we={};var Te=ge;we=we=HTTPPolling;function HTTPPolling(e,t,r){Te.call(this||ke,e,t,r)}HTTPPolling.prototype.__proto__=Te.prototype;HTTPPolling.prototype.name="httppolling";HTTPPolling.prototype.setHandlers=function(){Te.prototype.setHandlers.call(this||ke);(this||ke).socket.removeListener("end",(this||ke).bound.end);(this||ke).socket.removeListener("close",(this||ke).bound.close)};HTTPPolling.prototype.setHeartbeatInterval=function(){return this||ke};HTTPPolling.prototype.handleRequest=function(e){Te.prototype.handleRequest.call(this||ke,e);if("GET"==e.method){var t=this||ke;(this||ke).pollTimeout=setTimeout((function(){t.packet({type:"noop"});t.log.debug(t.name+" closed due to exceeded duration")}),1e3*(this||ke).manager.get("polling duration"));(this||ke).log.debug("setting poll timeout")}};HTTPPolling.prototype.clearPollTimeout=function(){if((this||ke).pollTimeout){clearTimeout((this||ke).pollTimeout);(this||ke).pollTimeout=null;(this||ke).log.debug("clearing poll timeout")}return this||ke};HTTPPolling.prototype.clearTimeouts=function(){Te.prototype.clearTimeouts.call(this||ke);this.clearPollTimeout()};HTTPPolling.prototype.doWrite=function(){this.clearPollTimeout()};HTTPPolling.prototype.write=function(e,t){this.doWrite(e);(this||ke).response.end();this.onClose()};HTTPPolling.prototype.end=function(e){this.clearPollTimeout();return Te.prototype.end.call(this||ke,e)};var xe=we;var Pe="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var Se={};var Ce=u.Buffer;var Me=xe;Se=Se=XHRPolling;function XHRPolling(e,t,r){Me.call(this||Pe,e,t,r)}XHRPolling.prototype.__proto__=Me.prototype;XHRPolling.prototype.name="xhr-polling";XHRPolling.prototype.doWrite=function(e){Me.prototype.doWrite.call(this||Pe);var t=(this||Pe).req.headers.origin,r={"Content-Type":"text/plain; charset=UTF-8","Content-Length":void 0===e?0:Ce.byteLength(e),Connection:"Keep-Alive"};if(t){r["Access-Control-Allow-Origin"]=t;r["Access-Control-Allow-Credentials"]="true"}(this||Pe).response.writeHead(200,r);(this||Pe).response.write(e);(this||Pe).log.debug((this||Pe).name+" writing",e)};var _e=Se;var Oe="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var He={};var qe=u.Buffer;var De=xe;var Be=/^\d+$/;He=He=JSONPPolling;function JSONPPolling(e,t,r){De.call(this||Oe,e,t,r);(this||Oe).head="io.j[0](";(this||Oe).foot=");";t.query.i&&Be.test(t.query.i)&&((this||Oe).head="io.j["+t.query.i+"](")}JSONPPolling.prototype.__proto__=De.prototype;JSONPPolling.prototype.name="jsonppolling";JSONPPolling.prototype.postEncoded=true;JSONPPolling.prototype.onData=function(e){try{e=JSON.parse(e)}catch(e){this.error("parse","reconnect");return}De.prototype.onData.call(this||Oe,e)};JSONPPolling.prototype.doWrite=function(e){De.prototype.doWrite.call(this||Oe);var e=void 0===e?"":(this||Oe).head+JSON.stringify(e)+(this||Oe).foot;(this||Oe).response.writeHead(200,{"Content-Type":"text/javascript; charset=UTF-8","Content-Length":qe.byteLength(e),Connection:"Keep-Alive","X-XSS-Protection":"0"});(this||Oe).response.write(e);(this||Oe).log.debug((this||Oe).name+" writing",e)};var We=He;var Fe={};Fe={websocket:ne,flashsocket:ce,htmlfile:be,"xhr-polling":_e,"jsonp-polling":We};var Le=Fe;var $e="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var Ee={};var je=s,Ae=h;Ee=Ee=Memory;Memory.Client=Client;function Memory(e){Ae.call(this||$e,e)}Memory.prototype.__proto__=Ae.prototype;Memory.prototype.publish=function(){};Memory.prototype.subscribe=function(){};Memory.prototype.unsubscribe=function(){};function Client(){Ae.Client.apply(this||$e,arguments);(this||$e).data={}}Client.prototype.__proto__=Ae.Client;Client.prototype.get=function(e,t){t(null,void 0===(this||$e).data[e]?null:(this||$e).data[e]);return this||$e};Client.prototype.set=function(e,t,r){(this||$e).data[e]=t;r&&r(null);return this||$e};Client.prototype.has=function(e,t){t(null,e in(this||$e).data)};Client.prototype.del=function(e,t){delete(this||$e).data[e];t&&t(null);return this||$e};Client.prototype.destroy=function(e){if("number"!=typeof e)(this||$e).data={};else{var t=this||$e;setTimeout((function(){t.data={}}),1e3*e)}return this||$e};var ze=Ee;var Ie="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var Re={};var Ne=u.Buffer;var Ue=e,Je=v,Xe=o,Ge=a;var Ve={js:{type:"application/javascript",encoding:"utf8",gzip:true},swf:{type:"application/x-shockwave-flash",encoding:"binary",gzip:false}};var Ke=/\+((?:\+)?[\w\-]+)*(?:\.v\d+\.\d+\.\d+)?(?:\.js)$/,Qe=/\.v\d+\.\d+\.\d+(?:\.js)$/;Re=Re=Static;function Static(e){(this||Ie).manager=e;(this||Ie).cache={};(this||Ie).paths={};this.init()}Static.prototype.init=function(){function id(e){var t=e.join("").split("").map((function(e){return(""+e.charCodeAt(0)).split("").pop()})).reduce((function(e,t){return e+t}));return Ue.version+":"+t}function build(t,r){Ue.builder(t,{minify:e.manager.enabled("browser client minification")},(function(e,o){r(e,o?new Ne(o):null,id(t))}))}var e=this||Ie;this.add("/static/flashsocket/WebSocketMain.swf",{file:Ue.dist+"/WebSocketMain.swf"});this.add("/static/flashsocket/WebSocketMainInsecure.swf",{file:Ue.dist+"/WebSocketMainInsecure.swf"});this.add("/socket.io.js",(function(t,r){build(e.manager.get("transports"),r)}));this.add("/socket.io.v",{mime:Ve.js},(function(t,r){build(e.manager.get("transports"),r)}));this.add("/socket.io+",{mime:Ve.js},(function(t,r){var o=e.manager.get("transports"),n=t.match(Ke),i=[];if(!n)return r("No valid transports");n[0].split(".")[0].split("+").slice(1).forEach((function(e){!~o.indexOf(e)||i.push(e)}));if(!i.length)return r("No valid transports");build(i,r)}));(this||Ie).manager.on("set:transports",(function(t,r){delete e.cache["/socket.io.js"];Object.keys(e.cache).forEach((function(t){Ke.test(t)&&delete e.cache[t]}))}))};Static.prototype.gzip=function(e,t){var r=Je.spawn("gzip",["-9","-c","-f","-n"]),o=Ne.isBuffer(e)?"binary":"utf8",n=[],i;r.stdout.on("data",(function(e){n.push(e)}));r.stderr.on("data",(function(e){i=e+"";n.length=0}));r.on("close",(function(){if(i)return t(i);var e=0,r=0,o=n.length,s;while(o--)e+=n[o].length;s=new Ne(e);o=n.length;n.forEach((function(e){var t=e.length;e.copy(s,r,0,t);r+=t}));n.length=0;t(null,s)}));r.stdin.end(e,o)};Static.prototype.has=function(e){if((this||Ie).paths[e])return(this||Ie).paths[e];var t=Object.keys((this||Ie).paths),r=t.length;while(r--)if(-~e.indexOf(t[r]))return(this||Ie).paths[t[r]];return false};Static.prototype.add=function(e,t,r){var o=/(?:\.(\w{1,4}))$/.exec(e);if(!r&&"function"==typeof t){r=t;t={}}t.mime=t.mime||!!o&&Ve[o[1]];r&&(t.callback=r);if(!(t.file||t.callback)||!t.mime)return false;(this||Ie).paths[e]=t;return true};Static.prototype.write=function(e,t,r){function write(e,o,n,i){try{r.writeHead(e,o||void 0);r.end("HEAD"!==t.method&&n?n:"",i||void 0)}catch(e){}}function answer(r){var n=t.headers["if-none-match"]===r.etag;if(n&&o.manager.enabled("browser client etag"))return write(304);var i=t.headers["accept-encoding"]||"",s=!!~i.toLowerCase().indexOf("gzip"),a=r.mime,c=r.versioned,h={"Content-Type":a.type};o.manager.enabled("browser client etag")&&r.etag&&!c&&(h["Etag"]=r.etag);if(c){var l=o.manager.get("browser client expires");h["Cache-Control"]='private, x-gzip-ok="", max-age='+l;h["Date"]=(new Date).toUTCString();h["Expires"]=new Date(Date.now()+1e3*l).toUTCString()}if(s&&r.gzip){h["Content-Length"]=r.gzip.length;h["Content-Encoding"]="gzip";h["Vary"]="Accept-Encoding";write(200,h,r.gzip.content,a.encoding)}else{h["Content-Length"]=r.length;write(200,h,r.content,a.encoding)}o.manager.log.debug("served static content "+e)}var o=this||Ie,n;if((this||Ie).manager.enabled("browser client cache")&&(this||Ie).cache[e])return answer((this||Ie).cache[e]);if((this||Ie).manager.get("browser client handler"))return(this||Ie).manager.get("browser client handler").call(this||Ie,t,r);if(n=this.has(e)){function ready(t,r,i){if(t){o.manager.log.warn("Unable to serve file. "+(t.message||t));return write(500,null,"Error serving static "+e)}var s=o.cache[e]={content:r,length:r.length,mime:n.mime,etag:i||Ue.version,versioned:Qe.test(e)};n.mime.gzip&&o.manager.enabled("browser client gzip")?o.gzip(r,(function(e,t){e||(s.gzip={content:t,length:t.length});answer(s)})):answer(s)}n.file?Xe.readFile(n.file,ready):n.callback?n.callback.call(this||Ie,e,ready):write(404,null,"File handle not found")}else write(404,null,"File not found")};var Ye=Re;var Ze="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var et={};var tt=u.Buffer;var rt=b;var ot=o,nt=n,it=i,st=s,at=a,ct=h,ht=e,lt=Le,pt=m,ft=f,ut=ze,dt=y,gt=Ye,mt=c.EventEmitter;et=et=Manager;var yt=et.defaultTransports=["websocket","htmlfile","xhr-polling","jsonp-polling"];var vt=(void 0).exports,bt=vt.protocol,kt=/^\d+$/;function Manager(e,t){(this||Ze).server=e;(this||Ze).namespaces={};(this||Ze).sockets=this.of("");(this||Ze).settings={origins:"*:*",log:true,store:new ut,logger:new pt,static:new gt(this||Ze),heartbeats:true,resource:"/socket.io",transports:yt,authorization:false,blacklist:["disconnect"],"log level":3,"log colors":it.isatty(rt.stdout.fd),"close timeout":60,"heartbeat interval":25,"heartbeat timeout":60,"polling duration":20,"flash policy server":true,"flash policy port":10843,"destroy upgrade":true,"destroy buffer size":1e8,"browser client":true,"browser client cache":true,"browser client minification":false,"browser client etag":false,"browser client expires":31536e4,"browser client gzip":false,"browser client handler":false,"client store expiration":15,"match origin protocol":false};for(var r in t)t.hasOwnProperty(r)&&((this||Ze).settings[r]=t[r]);var o=this||Ze;e.on("error",(function(e){o.log.warn("error raised: "+e)}));this.initStore();this.on("set:store",(function(){o.initStore()}));(this||Ze).oldListeners=e.listeners("request").splice(0);e.removeAllListeners("request");e.on("request",(function(e,t){o.handleRequest(e,t)}));e.on("upgrade",(function(e,t,r){o.handleUpgrade(e,t,r)}));e.on("close",(function(){clearInterval(o.gc)}));e.once("listening",(function(){o.gc=setInterval(o.garbageCollection.bind(o),1e4)}));for(var r in lt)lt.hasOwnProperty(r)&&lt[r].init&&lt[r].init(this||Ze);var o=this||Ze;(this||Ze).sockets.on("connection",(function(e){o.emit("connection",e)}));(this||Ze).sequenceNumber=0|Date.now();(this||Ze).log.info("socket.io started")}Manager.prototype.__proto__=mt.prototype;Manager.prototype.__defineGetter__("store",(function(){var e=this.get("store");e.manager=this||Ze;return e}));Manager.prototype.__defineGetter__("log",(function(){var e=this.get("logger");e.level=this.get("log level")||-1;e.colors=this.get("log colors");e.enabled=this.enabled("log");return e}));Manager.prototype.__defineGetter__("static",(function(){return this.get("static")}));Manager.prototype.get=function(e){return(this||Ze).settings[e]};Manager.prototype.set=function(e,t){if(1==arguments.length)return this.get(e);(this||Ze).settings[e]=t;this.emit("set:"+e,(this||Ze).settings[e],e);return this||Ze};Manager.prototype.enable=function(e){(this||Ze).settings[e]=true;this.emit("set:"+e,(this||Ze).settings[e],e);return this||Ze};Manager.prototype.disable=function(e){(this||Ze).settings[e]=false;this.emit("set:"+e,(this||Ze).settings[e],e);return this||Ze};Manager.prototype.enabled=function(e){return!!(this||Ze).settings[e]};Manager.prototype.disabled=function(e){return!(this||Ze).settings[e]};Manager.prototype.configure=function(e,t){"function"==typeof e?e.call(this||Ze):e==("production"||"development")&&t.call(this||Ze);return this||Ze};Manager.prototype.initStore=function(){(this||Ze).handshaken={};(this||Ze).connected={};(this||Ze).open={};(this||Ze).closed={};(this||Ze).rooms={};(this||Ze).roomClients={};var e=this||Ze;(this||Ze).store.subscribe("handshake",(function(t,r){e.onHandshake(t,r)}));(this||Ze).store.subscribe("connect",(function(t){e.onConnect(t)}));(this||Ze).store.subscribe("open",(function(t){e.onOpen(t)}));(this||Ze).store.subscribe("join",(function(t,r){e.onJoin(t,r)}));(this||Ze).store.subscribe("leave",(function(t,r){e.onLeave(t,r)}));(this||Ze).store.subscribe("close",(function(t){e.onClose(t)}));(this||Ze).store.subscribe("dispatch",(function(t,r,o,n){e.onDispatch(t,r,o,n)}));(this||Ze).store.subscribe("disconnect",(function(t){e.onDisconnect(t)}));(this||Ze).store.subscribe("message-remote",(function(t,r){e.onClientMessage(t,r)}));(this||Ze).store.subscribe("disconnect-remote",(function(t,r){e.onClientDisconnect(t,r)}));(this||Ze).store.subscribe("dispatch-remote",(function(t,r,o){var n=e.transports[t];n&&n.onDispatch(r,o);o||e.onClientDispatch(t,r)}));(this||Ze).store.subscribe("heartbeat-clear",(function(t){var r=e.transports[t];r&&r.onHeartbeatClear()}));(this||Ze).store.subscribe("disconnect-force",(function(t){var r=e.transports[t];r&&r.onForcedDisconnect()}))};Manager.prototype.onHandshake=function(e,t){(this||Ze).handshaken[e]=t};Manager.prototype.onConnect=function(e){(this||Ze).connected[e]=true};Manager.prototype.onOpen=function(e){(this||Ze).open[e]=true;if((this||Ze).closed[e]){var t=this||Ze;var r=t.transports[e];if(t.closed[e]&&t.closed[e].length&&r&&r.open){r.payload(t.closed[e]);t.closed[e]=[]}}if((this||Ze).transports[e]){(this||Ze).transports[e].discard();(this||Ze).transports[e]=null}};Manager.prototype.onDispatch=function(e,t,r,o){if((this||Ze).rooms[e])for(var n=0,i=(this||Ze).rooms[e].length;n<i;n++){var s=(this||Ze).rooms[e][n];~o.indexOf(s)||((this||Ze).transports[s]&&(this||Ze).transports[s].open?(this||Ze).transports[s].onDispatch(t,r):r||this.onClientDispatch(s,t))}};Manager.prototype.onJoin=function(e,t){(this||Ze).roomClients[e]||((this||Ze).roomClients[e]={});(this||Ze).rooms[t]||((this||Ze).rooms[t]=[]);if(!~(this||Ze).rooms[t].indexOf(e)){(this||Ze).rooms[t].push(e);(this||Ze).roomClients[e][t]=true}};Manager.prototype.onLeave=function(e,t){if((this||Ze).rooms[t]){var r=(this||Ze).rooms[t].indexOf(e);r>=0&&(this||Ze).rooms[t].splice(r,1);(this||Ze).rooms[t].length||delete(this||Ze).rooms[t];(this||Ze).roomClients[e]&&delete(this||Ze).roomClients[e][t]}};Manager.prototype.onClose=function(e){(this||Ze).open[e]&&delete(this||Ze).open[e];(this||Ze).closed[e]=[];var t=this||Ze};Manager.prototype.onClientDispatch=function(e,t){(this||Ze).closed[e]&&(this||Ze).closed[e].push(t)};Manager.prototype.onClientMessage=function(e,t){(this||Ze).namespaces[t.endpoint]&&(this||Ze).namespaces[t.endpoint].handlePacket(e,t)};Manager.prototype.onClientDisconnect=function(e,t){for(var r in(this||Ze).namespaces)(this||Ze).namespaces.hasOwnProperty(r)&&(this||Ze).namespaces[r].handleDisconnect(e,t,"undefined"!==typeof(this||Ze).roomClients[e]&&"undefined"!==typeof(this||Ze).roomClients[e][r]);this.onDisconnect(e)};Manager.prototype.onDisconnect=function(e){delete(this||Ze).handshaken[e];(this||Ze).open[e]&&delete(this||Ze).open[e];(this||Ze).connected[e]&&delete(this||Ze).connected[e];if((this||Ze).transports[e]){(this||Ze).transports[e].discard();delete(this||Ze).transports[e]}(this||Ze).closed[e]&&delete(this||Ze).closed[e];if((this||Ze).roomClients[e]){for(var t in(this||Ze).roomClients[e])(this||Ze).roomClients[e].hasOwnProperty(t)&&this.onLeave(e,t);delete(this||Ze).roomClients[e]}(this||Ze).store.destroyClient(e,this.get("client store expiration"))};Manager.prototype.handleRequest=function(e,t){var r=this.checkRequest(e);if(r)if(r.static||!r.transport&&!r.protocol)if(r.static&&this.enabled("browser client"))(this||Ze).static.write(r.path,e,t);else{t.writeHead(200);t.end("Welcome to socket.io.");(this||Ze).log.info("unhandled socket.io url")}else if(r.protocol!=bt){t.writeHead(500);t.end("Protocol version not supported.");(this||Ze).log.info("client protocol version unsupported")}else r.id?this.handleHTTPRequest(r,e,t):this.handleHandshake(r,e,t);else for(var o=0,n=(this||Ze).oldListeners.length;o<n;o++)(this||Ze).oldListeners[o].call((this||Ze).server,e,t)};Manager.prototype.handleUpgrade=function(e,t,r){var o=this.checkRequest(e),n=this||Ze;if(o){e.head=r;this.handleClient(o,e);e.head=null}else if(this.enabled("destroy upgrade")){t.end();(this||Ze).log.debug("destroying non-socket.io upgrade")}};Manager.prototype.handleHTTPRequest=function(e,t,r){t.res=r;this.handleClient(e,t)};Manager.prototype.handleClient=function(e,t){var r=t.socket,o=(this||Ze).store,n=this||Ze;if(void 0==e.query.disconnect)if(~this.get("transports").indexOf(e.transport)){var i=new lt[e.transport](this||Ze,e,t),s=(this||Ze).handshaken[e.id];if(i.disconnected)t.connection.end();else if(s){if(i.open){if((this||Ze).closed[e.id]&&(this||Ze).closed[e.id].length){i.payload((this||Ze).closed[e.id]);(this||Ze).closed[e.id]=[]}this.onOpen(e.id);(this||Ze).store.publish("open",e.id);(this||Ze).transports[e.id]=i}if(!(this||Ze).connected[e.id]){this.onConnect(e.id);(this||Ze).store.publish("connect",e.id);delete s.issued;this.onHandshake(e.id,s);(this||Ze).store.publish("handshake",e.id,s);for(var a in(this||Ze).namespaces)if((this||Ze).namespaces.hasOwnProperty(a)){var r=(this||Ze).namespaces[a].socket(e.id,true);""===a&&(this||Ze).namespaces[a].handlePacket(e.id,{type:"connect"})}}}else{i.open&&i.error("client not handshaken","reconnect");i.discard()}}else{(this||Ze).log.warn('unknown transport: "'+e.transport+'"');t.connection.end()}else{(this||Ze).transports[e.id]&&(this||Ze).transports[e.id].open?(this||Ze).transports[e.id].onForcedDisconnect():(this||Ze).store.publish("disconnect-force",e.id);t.res.writeHead(200);t.res.end()}};Manager.prototype.generateId=function(){var e=new tt(15);if(!e.writeInt32BE)return Math.abs(Math.random()*Math.random()*Date.now()|0).toString()+Math.abs(Math.random()*Math.random()*Date.now()|0).toString();(this||Ze).sequenceNumber=(this||Ze).sequenceNumber+1|0;e.writeInt32BE((this||Ze).sequenceNumber,11);st.randomBytes?st.randomBytes(12).copy(e):[0,4,8].forEach((function(t){e.writeInt32BE(Math.random()*Math.pow(2,32)|0,t)}));return e.toString("base64").replace(/\//g,"_").replace(/\+/g,"-")};Manager.prototype.handleHandshake=function(e,t,r){var o=this||Ze,n=t.headers.origin,i={"Content-Type":"text/plain"};function writeErr(t,o){if(e.query.jsonp&&kt.test(e.query.jsonp)){r.writeHead(200,{"Content-Type":"application/javascript"});r.end("io.j["+e.query.jsonp+'](new Error("'+o+'"));')}else{r.writeHead(t,i);r.end(o)}}function error(e){writeErr(500,"handshake error");o.log.warn("handshake error "+e)}if(this.verifyOrigin(t)){var s=this.handshakeData(e);if(n){i["Access-Control-Allow-Origin"]=n;i["Access-Control-Allow-Credentials"]="true"}this.authorize(s,(function(t,n,a){if(t)return error(t);if(n){var c=o.generateId(),h=[c,o.enabled("heartbeats")&&o.get("heartbeat timeout")||"",o.get("close timeout")||"",o.transports(e).join(",")].join(":");if(e.query.jsonp&&kt.test(e.query.jsonp)){h="io.j["+e.query.jsonp+"]("+JSON.stringify(h)+");";r.writeHead(200,{"Content-Type":"application/javascript"})}else r.writeHead(200,i);o.onHandshake(c,a||s);o.store.publish("handshake",c,a||s);r.end(h);o.log.info("handshake authorized",c)}else{writeErr(403,"handshake unauthorized");o.log.info("handshake unauthorized")}}))}else writeErr(403,"handshake bad origin")};Manager.prototype.handshakeData=function(e){var t=e.request.connection,r,o=new Date;t.remoteAddress?r={address:t.remoteAddress,port:t.remotePort}:t.socket&&t.socket.remoteAddress&&(r={address:t.socket.remoteAddress,port:t.socket.remotePort});return{headers:e.headers,address:r,time:o.toString(),query:e.query,url:e.request.url,xdomain:!!e.request.headers.origin,secure:e.request.connection.secure,issued:+o}};Manager.prototype.verifyOrigin=function(e){var t=e.headers.origin||e.headers.referer,r=this.get("origins");"null"===t&&(t="*");if(-1!==r.indexOf("*:*"))return true;if(t)try{var o=nt.parse(t);o.port=o.port||80;var n=~r.indexOf(o.hostname+":"+o.port)||~r.indexOf(o.hostname+":*")||~r.indexOf("*:"+o.port);n||(this||Ze).log.warn("illegal origin: "+t);return n}catch(e){(this||Ze).log.warn("error parsing origin")}else(this||Ze).log.warn("origin missing from handshake, yet required by config");return false};Manager.prototype.handlePacket=function(e,t){this.of(t.endpoint||"").handlePacket(e,t)};Manager.prototype.authorize=function(e,t){if(this.get("authorization")){var r=this||Ze;this.get("authorization").call(this||Ze,e,(function(e,o){r.log.debug("client "+o?"authorized":"unauthorized");t(e,o)}))}else{(this||Ze).log.debug("client authorized");t(null,true)}return this||Ze};Manager.prototype.transports=function(e){var t=this.get("transports"),r=[];for(var o=0,n=t.length;o<n;o++){var i=t[o];i&&(i.checkClient&&!i.checkClient(e)||r.push(i))}return r};var wt=/^\/([^\/]+)\/?([^\/]+)?\/?([^\/]+)?\/?$/;Manager.prototype.checkRequest=function(e){var t=this.get("resource");var r;if("string"===typeof t){r=e.url.substr(0,t.length);r!==t&&(r=null)}else{r=t.exec(e.url);r&&(r=r[0])}if(r){var o=nt.parse(e.url.substr(r.length),true),n=o.pathname||"",i=n.match(wt);var s={query:o.query||{},headers:e.headers,request:e,path:n};if(i){s.protocol=Number(i[1]);s.transport=i[2];s.id=i[3];s.static=!!(this||Ze).static.has(n)}return s}return false};Manager.prototype.of=function(e){return(this||Ze).namespaces[e]?(this||Ze).namespaces[e]:(this||Ze).namespaces[e]=new dt(this||Ze,e)};Manager.prototype.garbageCollection=function(){var e=Object.keys((this||Ze).handshaken),t=e.length,r=Date.now(),o;while(t--){o=(this||Ze).handshaken[e[t]];"issued"in o&&r-o.issued>=3e4&&this.onDisconnect(e[t])}};var Tt=et;var xt={};var Pt=e;xt.version="0.9.16";xt.protocol=1;xt.clientVersion=Pt.version;xt.listen=function(e,o,n){"function"==typeof e&&console.warn("Socket.IO's `listen()` method expects an `http.Server` instance\n"+"as its first parameter. Are you migrating from Express 2.x to 3.x?\n"+'If so, check out the "Socket.IO compatibility" section at:\n'+"https://github.com/visionmedia/express/wiki/Migrating-from-2.x-to-3.x");if("function"==typeof o){n=o;o={}}"undefined"==typeof e&&(e=80);if("number"==typeof e){var i=e;e=o&&o.key?t.createServer(o):r.createServer();e.on("request",(function(e,t){t.writeHead(200);t.end("Welcome to socket.io.")}));e.listen(i,n)}return new xt.Manager(e,o)};xt.Manager=Tt;xt.Transport=x;xt.Socket=f;xt.Static=Ye;xt.Store=h;xt.MemoryStore=ze;xt.RedisStore=l;xt.parser=p;const St=xt.version,Ct=xt.protocol,Mt=xt.clientVersion,_t=xt.listen,Ot=xt.Manager,Ht=xt.Transport,qt=xt.Socket,Dt=xt.Static,Bt=xt.Store,Wt=xt.MemoryStore,Ft=xt.RedisStore,Lt=xt.parser;export default xt;export{Ot as Manager,Wt as MemoryStore,Ft as RedisStore,qt as Socket,Dt as Static,Bt as Store,Ht as Transport,Mt as clientVersion,_t as listen,Lt as parser,Ct as protocol,St as version};

