// xmlhttprequest@1.4.2 downloaded from https://ga.jspm.io/npm:xmlhttprequest@1.4.2/lib/XMLHttpRequest.js

import e from"url";import t from"child_process";import r from"fs";import s from"http";import n from"https";import o from"process";import a from"buffer";var i;var h="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var c={};var f=a.Buffer;var u=o;
/**
 * Wrapper for built-in http.js to emulate the browser XMLHttpRequest object.
 *
 * This can be used with JS designed for browsers to improve reuse of code and
 * allow the use of existing libraries.
 *
 * Usage: include("XMLHttpRequest.js") and use XMLHttpRequest per W3C specs.
 *
 * @author Dan DeFelippi <dan@driverdan.com>
 * @contributor David Ellis <d.f.ellis@ieee.org>
 * @license MIT
 */var d=e,l=t.spawn,p=r;c.XMLHttpRequest=function(){var e=this||h;var t=s;var r=n;var o;var a;var c;var E={};var T={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"};var v=T;var S=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"];var y=["TRACE","TRACK","CONNECT"];var R=false;var N=false;var O={};(this||h).UNSENT=0;(this||h).OPENED=1;(this||h).HEADERS_RECEIVED=2;(this||h).LOADING=3;(this||h).DONE=4;(this||h).readyState=(this||h).UNSENT;(this||h).onreadystatechange=null;(this||h).responseText="";(this||h).responseXML="";(this||h).status=null;(this||h).statusText=null;var isAllowedHttpHeader=function(e){return e&&-1===S.indexOf(e.toLowerCase())};var isAllowedHttpMethod=function(e){return e&&-1===y.indexOf(e)};(this||h).open=function(e,t,r,s,n){this.abort();N=false;if(!isAllowedHttpMethod(e)){throw"SecurityError: Request method not allowed";return}E={method:e,url:t.toString(),async:"boolean"!==typeof r||r,user:s||null,password:n||null};setState((this||h).OPENED)};(this||h).setRequestHeader=function(e,t){if((this||h).readyState!=(this||h).OPENED)throw"INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN";if(isAllowedHttpHeader(e)){if(R)throw"INVALID_STATE_ERR: send flag is true";v[e]=t}else console.warn('Refused to set unsafe header "'+e+'"')};(this||h).getResponseHeader=function(e){return"string"===typeof e&&(this||h).readyState>(this||h).OPENED&&c.headers[e.toLowerCase()]&&!N?c.headers[e.toLowerCase()]:null};(this||h).getAllResponseHeaders=function(){if((this||h).readyState<(this||h).HEADERS_RECEIVED||N)return"";var e="";for(var t in c.headers)"set-cookie"!==t&&"set-cookie2"!==t&&(e+=t+": "+c.headers[t]+"\r\n");return e.substr(0,e.length-2)};(this||h).getRequestHeader=function(e){return"string"===typeof e&&v[e]?v[e]:""};(this||h).send=function(s){if((this||h).readyState!=(this||h).OPENED)throw"INVALID_STATE_ERR: connection must be opened before send() is called";if(R)throw"INVALID_STATE_ERR: send has already been called";var n=false,o=false;var T=d.parse(E.url);switch(T.protocol){case"https:":n=true;case"http:":var S=T.hostname;break;case"file:":o=true;break;case void 0:case"":var S="localhost";break;default:throw"Protocol not supported."}if(o){if("GET"!==E.method)throw"XMLHttpRequest: Only GET method is supported";if(E.async)p.readFile(T.pathname,"utf8",(function(t,r){if(t)e.handleError(t);else{e.status=200;e.responseText=r;setState(e.DONE)}}));else try{(this||h).responseText=p.readFileSync(T.pathname,"utf8");(this||h).status=200;setState(e.DONE)}catch(e){this.handleError(e)}}else{var y=T.port||(n?443:80);var O=T.pathname+(T.search?T.search:"");v["Host"]=S;n&&443===y||80===y||(v["Host"]+=":"+T.port);if(E.user){"undefined"==typeof E.password&&(E.password="");var D=new f(E.user+":"+E.password);v["Authorization"]="Basic "+D.toString("base64")}if("GET"===E.method||"HEAD"===E.method)s=null;else if(s){v["Content-Length"]=f.byteLength(s);v["Content-Type"]||(v["Content-Type"]="text/plain;charset=UTF-8")}else"POST"===E.method&&(v["Content-Length"]=0);var g={host:S,port:y,path:O,method:E.method,headers:v};N=false;if(E.async){var m=n?r.request:t.request;R=true;e.dispatchEvent("readystatechange");a=m(g,(function(t){c=t;c.setEncoding("utf8");setState(e.HEADERS_RECEIVED);e.status=c.statusCode;c.on("data",(function(t){t&&(e.responseText+=t);R&&setState(e.LOADING)}));c.on("end",(function(){if(R){setState(e.DONE);R=false}}));c.on("error",(function(t){e.handleError(t)}))})).on("error",(function(t){e.handleError(t)}));s&&a.write(s);a.end();e.dispatchEvent("loadstart")}else{var w=".node-xmlhttprequest-sync-"+u.pid;p.writeFileSync(w,"","utf8");var L="var http = require('http'), https = require('https'), fs = require('fs');"+"var doRequest = http"+(n?"s":"")+".request;"+"var options = "+JSON.stringify(g)+";"+"var responseText = '';"+"var req = doRequest(options, function(response) {"+"response.setEncoding('utf8');"+"response.on('data', function(chunk) {"+"responseText += chunk;"+"});"+"response.on('end', function() {"+"fs.writeFileSync('"+w+"', 'NODE-XMLHTTPREQUEST-STATUS:' + response.statusCode + ',' + responseText, 'utf8');"+"});"+"response.on('error', function(error) {"+"fs.writeFileSync('"+w+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');"+"});"+"}).on('error', function(error) {"+"fs.writeFileSync('"+w+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');"+"});"+(s?"req.write('"+s.replace(/'/g,"\\'")+"');":"")+"req.end();";h.syncProc=i=l(u.argv[0],["-e",L]);while(""==(e.responseText=p.readFileSync(w,"utf8")));i.stdin.end();p.unlinkSync(w);if(e.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)){var x=e.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,"");e.handleError(x)}else{e.status=e.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1");e.responseText=e.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1");setState(e.DONE)}}}};(this||h).handleError=function(e){(this||h).status=503;(this||h).statusText=e;(this||h).responseText=e.stack;N=true;setState((this||h).DONE)};(this||h).abort=function(){if(a){a.abort();a=null}v=T;(this||h).responseText="";(this||h).responseXML="";N=true;if((this||h).readyState!==(this||h).UNSENT&&((this||h).readyState!==(this||h).OPENED||R)&&(this||h).readyState!==(this||h).DONE){R=false;setState((this||h).DONE)}(this||h).readyState=(this||h).UNSENT};(this||h).addEventListener=function(e,t){e in O||(O[e]=[]);O[e].push(t)};(this||h).removeEventListener=function(e,t){e in O&&(O[e]=O[e].filter((function(e){return e!==t})))};(this||h).dispatchEvent=function(t){"function"===typeof e["on"+t]&&e["on"+t]();if(t in O)for(var r=0,s=O[t].length;r<s;r++)O[t][r].call(e)};var setState=function(t){if(e.readyState!==t){e.readyState=t;(E.async||e.readyState<e.OPENED||e.readyState===e.DONE)&&e.dispatchEvent("readystatechange");if(e.readyState===e.DONE&&!N){e.dispatchEvent("load");e.dispatchEvent("loadend")}}}};const E=c.XMLHttpRequest;export default c;export{E as XMLHttpRequest};

