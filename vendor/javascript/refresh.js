// refresh@1.0.1 downloaded from https://ga.jspm.io/npm:refresh@1.0.1/refresh.js

import e from"commander";import t from"http";import r from"url";import o from"fs";import n from"watch";import s from"sys";import i from"child_process";import a from"socket.io";import c from"util";import h from"https";import u from"events";import p from"pkginfo";import f from"process";import d from"buffer";var l={},g=false;var m="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;function dew(){var e,t,r;if(g)return l;g=true;var c=o;var h=n;var u=s;var p=i.exec;var f;var watch_dir=function(e){(this||m).path=e;(this||m).watch_for=Inotify.IN_OPEN|Inotify.IN_CLOSE;(this||m).callback=callback};var d={directory:"",socket:null,command:true,updated:false,watch:function(r,o,n){m.that=e=this||m;e.directory=o;e.command=n;f=a.listen(r);r.on("request",(function(r){m.peer=t=r.client._peername;f.sockets.on("connection",(function(t){e.socket=t}))}));console.log(o);h.watchTree(o,(function(t,r,o){"object"==typeof t&&null===o&&null===r||(null===o||0===r.nlink,e.emmit())}));f.setMaxListeners(0);r.setMaxListeners(0);return(this||m).updated},emmit:function(){if(null!=(this||m).socket){m.connection=r=(this||m).socket.emit("update",{refresh:true});true!==(this||m).command&&p((this||m).command,(function(e,t,r){u.puts(t)}))}}};l=d;return l}var y={},v=false;function dew$1(){if(v)return y;v=true;var e={getLive:function(){e="<script src='/socket.io/socket.io.js'><\/script>\n";e+="<script>\n";e+="var socket = io.connect('http://localhost');\n";e+="socket.on('update', function (data) {\n";e+="\tif (data.refresh == true) {\n";e+="\t\twindow.location.reload(true);\n";e+="\t}\n";e+="});\n";e+="<\/script>\n";e+="</body>\n";return e}};y=e;return y}var w={},x=false;var b="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;function dew$2(){var e,r,n;if(x)return w;x=true;var s=d.Buffer;var i=f;var a=u,h=t,p=c,l=dew(),g=dew$1(),m=o,y=dew$5();var v=w.HttpProxy=function(e){if(!e||!e.target)throw new Error("Both `options` and `options.target` are required.");a.EventEmitter.call(this||b);var t=this||b;(this||b).forward=e.forward;(this||b).target=e.target;function setupProxy(e){t[e].agent=y._getAgent(t[e]);t[e].protocol=y._getProtocol(t[e]);t[e].base=y._getBase(t[e])}setupProxy("target");(this||b).forward&&setupProxy("forward");(this||b).enable=e.enable||{};(this||b).enable.xforward="boolean"!==typeof(this||b).enable.xforward||(this||b).enable.xforward;(this||b).source=e.source||{host:"localhost",port:8e3};(this||b).source.https=(this||b).source.https||e.https;(this||b).changeOrigin=e.changeOrigin||false};p.inherits(v,a.EventEmitter);function getProto(e){return e.isSpdy||e.connection.pair?"https":"http"}v.prototype.proxyRequest=function(t,o,s){var i=this||b,a=false,c=new(this||b).target.base,h;if((this||b).enable.xforward&&t.connection&&t.socket){if(t.headers["x-forwarded-for"]){var u=","+t.connection.remoteAddress||t.socket.remoteAddress;t.headers["x-forwarded-for"]+=u}else t.headers["x-forwarded-for"]=t.connection.remoteAddress||t.socket.remoteAddress;if(t.headers["x-forwarded-port"]){var p=","+t.connection.remotePort||t.socket.remotePort;t.headers["x-forwarded-port"]+=p}else t.headers["x-forwarded-port"]=t.connection.remotePort||t.socket.remotePort;if(t.headers["x-forwarded-proto"]){var f=","+getProto(t);t.headers["x-forwarded-proto"]+=f}else t.headers["x-forwarded-proto"]=getProto(t)}this.emit("start",t,o,(this||b).target);if((this||b).forward){this.emit("forward",t,o,(this||b).forward);this._forwardRequest(t)}function proxyError(e){a=true;if(!i.emit("proxyError",e,t,o)){o.writeHead(500,{"Content-Type":"text/plain"});"HEAD"!==t.method&&o.write("Internal Server Error");try{o.end()}catch(e){console.error("res.end error: %s",e.message)}}}c.host=(this||b).target.host;c.hostname=(this||b).target.hostname;c.port=(this||b).target.port;c.agent=(this||b).target.agent;c.method=t.method;c.path=t.url;c.headers=t.headers;(this||b).changeOrigin&&(c.headers.host=(this||b).target.host+":"+(this||b).target.port);h=(this||b).target.protocol.request(c,(function(s){s.headers.connection&&(t.headers.connection?s.headers.connection=t.headers.connection:s.headers.connection="close");"1.0"===t.httpVersion&&delete s.headers["transfer-encoding"];if(301===s.statusCode||302===s.statusCode){i.source.https&&!i.target.https&&(s.headers.location=s.headers.location.replace(/^http\:/,"https:"));i.target.https&&!i.source.https&&(s.headers.location=s.headers.location.replace(/^https\:/,"http:"))}o.writeHead(s.statusCode,s.headers);if(304!==s.statusCode){s.on("data",ondata);o.on("drain",ondrain);var c=false;s.on("close",(function(){c||s.emit("end")}));s.on("end",(function(){c=true;if(!a){h.removeListener("error",proxyError);try{o.end()}catch(e){console.error("res.end error: %s",e.message)}i.emit("end",t,o)}}))}else try{o.end()}catch(e){console.error("res.end error: %s",e.message)}function ondata(t){if(o.writable&&404!==s.statusCode){if(void 0!=s.headers["content-type"]&&-1!=s.headers["content-type"].indexOf("text/html")){b.livejs=e=g.getLive();e=e.toString("utf-8");b.chunkPartial=r=t.toString("utf-8");-1!=r.indexOf("</body>")?b.chunkFinal=n=r.replace("</body>",e):n=r+e;o.writeHead(200,{"Content-Length":n.length,"Content-Type":s.headers["content-type"]})}false===o.write(n,"binary")&&s.pause&&s.pause()}}function ondrain(){s.readable&&s.resume&&s.resume()}}));h.once("error",proxyError);t.on("aborted",(function(){h.abort()}));t.on("data",(function(e){if(!a){var r=h.write(e);if(!r){t.pause();h.once("drain",(function(){try{t.resume()}catch(e){console.error("req.resume error: %s",e.message)}}));setTimeout((function(){h.emit("drain")}),100)}}}));t.on("end",(function(){a||h.end()}));t.on("close",(function(){a||h.abort()}));if(s)return a?s.destroy():s.resume()};v.prototype.proxyWebSocketRequest=function(e,t,r,o){var n=this||b,a=new(this||b).target.base,c={},h=false,u="\r\n";if("GET"!==e.method||"websocket"!==e.headers.upgrade.toLowerCase())return t.destroy();if((this||b).enable.xforward&&e.connection&&e.connection.socket){if(e.headers["x-forwarded-for"]){var p=","+e.connection.remoteAddress||e.connection.socket.remoteAddress;e.headers["x-forwarded-for"]+=p}else e.headers["x-forwarded-for"]=e.connection.remoteAddress||e.connection.socket.remoteAddress;if(e.headers["x-forwarded-port"]){var f=","+e.connection.remotePort||e.connection.socket.remotePort;e.headers["x-forwarded-port"]+=f}else e.headers["x-forwarded-port"]=e.connection.remotePort||e.connection.socket.remotePort;if(e.headers["x-forwarded-proto"]){var d=","+(e.connection.pair?"wss":"ws");e.headers["x-forwarded-proto"]+=d}else e.headers["x-forwarded-proto"]=e.connection.pair?"wss":"ws"}function _socket(e,t){e.setTimeout(0);e.setNoDelay(true);t&&(e.setKeepAlive?e.setKeepAlive(true,0):e.pair.cleartext.socket.setKeepAlive&&e.pair.cleartext.socket.setKeepAlive(true,0))}_socket(t,true);function onUpgrade(o,s){if(o){s.on("data",c.onIncoming=function(i){if(o.incoming.socket.writable)try{n.emit("websocket:outgoing",e,t,r,i);var a=o.incoming.socket.write(i);if(!a){s.pause();o.incoming.socket.once("drain",(function(){try{s.resume()}catch(e){console.error("proxySocket.resume error: %s",e.message)}}));setTimeout((function(){o.incoming.socket.emit("drain")}),100)}}catch(e){detach()}});o.incoming.socket.on("data",c.onOutgoing=function(e){try{n.emit("websocket:incoming",o,o.incoming,r,e);var t=s.write(e);if(!t){o.incoming.socket.pause();s.once("drain",(function(){try{o.incoming.socket.resume()}catch(e){console.error("reverseProxy.incoming.socket.resume error: %s",e.message)}}));setTimeout((function(){s.emit("drain")}),100)}}catch(e){detach()}});s.on("end",c.onIncomingClose=function(){detach();n.emit("websocket:end",e,t,r)});o.incoming.socket.on("end",c.onOutgoingClose=function(){detach()})}else{s.end();t.end()}function detach(){s.destroySoon();s.removeListener("end",c.onIncomingClose);s.removeListener("data",c.onIncoming);o.incoming.socket.destroySoon();o.incoming.socket.removeListener("end",c.onOutgoingClose);o.incoming.socket.removeListener("data",c.onOutgoing)}}function getPort(e){e=e||80;return e-80===0?"":":"+e}var l=(this||b).target.agent,g=(this||b).target.https?"https":"http",m=getPort((this||b).source.port),y=(this||b).target.host+m;if((this||b).changeOrigin){e.headers.host=y;e.headers.origin=g+"://"+y}a.host=(this||b).target.host;a.port=(this||b).target.port;a.agent=l;a.method="GET";a.path=e.url;a.headers=e.headers;a.agent=l;var v=(this||b).target.protocol.request(a);function proxyError(o){v.destroy();i.nextTick((function(){t.destroy()}));n.emit("webSocketProxyError",e,t,r)}v.incoming={request:e,socket:t,head:r};v.on("upgrade",(function(e,t,r){_socket(t,true);onUpgrade(t._httpMessage,t)}));v.once("socket",(function(o){o.on("data",(function handshake(i){var a=i.toString();a=a.substr(0,a.search(u+u));i=i.slice(s.byteLength(a),i.length);n.source.https&&!n.target.https&&(a=a.replace("ws:","wss:"));try{n.emit("websocket:handshake",e,t,r,a,i);t.write(a);var c=t.write(i);if(!c){o.pause();t.once("drain",(function(){try{o.resume()}catch(e){console.error("reverseProxy.socket.resume error: %s",e.message)}}));setTimeout((function(){t.emit("drain")}),100)}}catch(e){o.removeListener("data",handshake);return proxyError(e)}t.on("error",proxyError);o.removeListener("data",handshake)}))}));v.on("error",proxyError);try{v.write(r);r&&0===r.length&&v._send("")}catch(e){return proxyError(e)}return o?h?o.destroy():o.resume():void 0};v.prototype.close=function(){[(this||b).forward,(this||b).target].forEach((function(e){if(e&&e.agent)for(var t in e.agent.sockets)e.agent.sockets[t].forEach((function(e){e.end()}))}))};v.prototype._forwardRequest=function(e){var t=this||b,r=new(this||b).forward.base,o;r.host=(this||b).forward.host;r.port=(this||b).forward.port,r.agent=(this||b).forward.agent;r.method=e.method;r.path=e.url;r.headers=e.headers;o=(this||b).forward.protocol.request(r,(function(e){}));o.once("error",(function(e){}));e.on("data",(function(t){var r=o.write(t);if(!r){e.pause();o.once("drain",(function(){try{e.resume()}catch(e){console.error("req.resume error: %s",e.message)}}));setTimeout((function(){o.emit("drain")}),100)}}));e.on("end",(function(){o.end()}))};return w}var k={},E=false;var P="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;function dew$3(){if(E)return k;E=true;var e=c,t=u,n=o,s=r;var i=k.ProxyTable=function(e){t.EventEmitter.call(this||P);(this||P).silent=e.silent||true!==e.silent;(this||P).target=e.target||{};(this||P).hostnameOnly=true===e.hostnameOnly;if("object"===typeof e.router)this.setRoutes(e.router);else{if("string"!==typeof e.router)throw new Error("Cannot parse router with unknown type: "+typeof router);var r=this||P;(this||P).routeFile=e.router;this.setRoutes(JSON.parse(n.readFileSync(e.router)).router);n.watchFile((this||P).routeFile,(function(){n.readFile(r.routeFile,(function(e,t){e&&r.emit("error",e);r.setRoutes(JSON.parse(t).router);r.emit("routes",false===r.hostnameOnly?r.routes:r.router)}))}))}};e.inherits(i,t.EventEmitter);i.prototype.setRoutes=function(e){if(!e)throw new Error("Cannot update ProxyTable routes without router.");var t=this||P;(this||P).router=e;if(false===(this||P).hostnameOnly){(this||P).routes=[];Object.keys(e).forEach((function(r){/http[s]?/.test(e[r])||(e[r]=(t.target.https?"https://":"http://")+e[r]);var o=s.parse(e[r]),n=t.target.https?443:80;t.routes.push({source:{regexp:new RegExp("^"+r,"i"),sref:r,url:s.parse("http://"+r)},target:{sref:o.hostname+":"+(o.port||n)+o.path,url:o}})}))}};i.prototype.getProxyLocation=function(e){if(!e||!e.headers||!e.headers.host)return null;var t=e.headers.host.split(":")[0];if(true===(this||P).hostnameOnly){if((this||P).router.hasOwnProperty(t)){var r=(this||P).router[t].split(":"),o=r[0],n=1===r.length?80:r[1];return{port:n,host:o}}}else{t+=e.url;for(var i in(this||P).routes){var a=(this||P).routes[i];if(t.match(a.source.regexp)){var c=s.parse(e.url);c.pathname=c.pathname.replace(a.source.url.pathname,a.target.url.pathname);e.url=s.format(c);return{protocol:a.target.url.protocol.replace(":",""),host:a.target.url.hostname,port:a.target.url.port||((this||P).target.https?443:80)}}}}return null};i.prototype.close=function(){"string"===typeof(this||P).routeFile&&n.unwatchFile((this||P).routeFile)};return k}var T={},S=false;var _="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;function dew$4(){if(S)return T;S=true;var e=u,t=c,r=dew$2().HttpProxy,o=dew$3().ProxyTable;var n=T.RoutingProxy=function(t){e.EventEmitter.call(this||_);var r=this||_;t=t||{};if(t.router){(this||_).proxyTable=new o(t);(this||_).proxyTable.on("routes",(function(e){r.emit("routes",e)}))}(this||_).proxies={};(this||_).target={};(this||_).target.https=t.target&&t.target.https;(this||_).source=t.source||{host:"localhost",port:8e3};(this||_).https=(this||_).source.https||t.https;(this||_).enable=t.enable;(this||_).forward=t.forward;(this||_).changeOrigin=t.changeOrigin||false;this.on("newListener",(function(e){"proxyError"!==e&&"webSocketProxyError"!==e||Object.keys(r.proxies).forEach((function(t){r.proxies[t].on(e,(this||_).emit.bind(this||_,e))}))}))};t.inherits(n,e.EventEmitter);n.prototype.add=function(e){var t=this||_,o=this._getKey(e);e.target=e.target||{};e.target.host=e.target.host||e.host;e.target.port=e.target.port||e.port;e.target.https=(this||_).target&&(this||_).target.https||e.target&&e.target.https;["https","enable","forward","changeOrigin"].forEach((function(r){false!==e[r]&&t[r]&&(e[r]=t[r])}));(this||_).proxies[o]=new r(e);this.listeners("proxyError").length>0&&(this||_).proxies[o].on("proxyError",(this||_).emit.bind(this||_,"proxyError"));this.listeners("webSocketProxyError").length>0&&(this||_).proxies[o].on("webSocketProxyError",(this||_).emit.bind(this||_,"webSocketProxyError"));(this||_).proxies[o].on("start",(this||_).emit.bind(this||_,"start"));(this||_).proxies[o].on("forward",(this||_).emit.bind(this||_,"forward"));(this||_).proxies[o].on("end",(this||_).emit.bind(this||_,"end"))};n.prototype.remove=function(e){var t=this._getKey(e),r=(this||_).proxies[t];delete(this||_).proxies[t];return r};n.prototype.close=function(){var e=this||_;(this||_).proxyTable&&(this||_).proxyTable.close();Object.keys((this||_).proxies).forEach((function(t){e.proxies[t].close()}))};n.prototype.proxyRequest=function(e,t,r){r=r||{};var o;if((this||_).proxyTable&&!r.host){o=(this||_).proxyTable.getProxyLocation(e);if(!o){try{t.writeHead(404);t.end()}catch(e){console.error("res.writeHead/res.end error: %s",e.message)}return}r.port=o.port;r.host=o.host}var n=this._getKey(r),s;if((this||_).target&&(this||_).target.https||o&&"https"===o.protocol){r.target=r.target||{};r.target.https=true}(this||_).proxies[n]||this.add(r);s=(this||_).proxies[n];s.proxyRequest(e,t,r.buffer)};n.prototype.proxyWebSocketRequest=function(e,t,r,o){o=o||{};var n,s,i;if((this||_).proxyTable&&!o.host){n=(this||_).proxyTable.getProxyLocation(e);if(!n)return t.destroy();o.port=n.port;o.host=n.host}i=this._getKey(o);(this||_).proxies[i]||this.add(o);s=(this||_).proxies[i];s.proxyWebSocketRequest(e,t,r,o.buffer)};n.prototype._getKey=function(e){if(!e||(!e.host||!e.port)&&(!e.target||!e.target.host||!e.target.port))throw new Error("options.host and options.port or options.target are required.");return[e.host||e.target.host,e.port||e.target.port].join(":")};return T}var O={},A=false;var q={exports:O};var L="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;function dew$5(){if(A)return q.exports;A=true;var e=c,r=t,o=h,n=u,s=100;p(q,"version");var i=O.HttpProxy=dew$2().HttpProxy,a=O.ProxyTable=dew$3().ProxyTable,f=O.RoutingProxy=dew$4().RoutingProxy;O.createServer=function(){var e=Array.prototype.slice.call(arguments),t=[],n,s={},a,c,h,u,p,d;e.forEach((function(e){switch(typeof e){case"string":p=e;break;case"number":d=e;break;case"object":s=e||{};break;case"function":n=e;t.push(n);break}}));function validArguments(){var e={"port and host":function(){return d&&p},"options.target or options.router":function(){return s&&(s.router||s.target&&s.target.host&&s.target.port)},"or proxy handlers":function(){return t&&t.length}};var r=Object.keys(e).filter((function(t){return!e[t]()}));if(3===r.length){a="Cannot proxy without "+r.join(", ");return false}return true}if(!validArguments()){throw new Error(a);return}s.target=s.target||{};s.target.port=s.target.port||d;s.target.host=s.target.host||p;if(s.target&&s.target.host&&s.target.port){u=new i(s);t.push((function(e,t){u.proxyRequest(e,t)}))}else{u=new f(s);if(s.router){t.push((function(e,t){u.proxyRequest(e,t)}));u.on("routes",(function(e){h.emit("routes",e)}))}}c=t.length>1?O.stack(t,u):function(e,r){t[0](e,r,u)};h=s.https?o.createServer(s.https,c):r.createServer(c);h.on("close",(function(){u.close()}));n||h.on("upgrade",(function(e,t,r){u.proxyWebSocketRequest(e,t,r)}));h.proxy=u;return h};O.buffer=function(e){var t=[],r,o;e.on("data",r=function(e,r){t.push(["data",e,r])});e.on("end",o=function(e,r){t.push(["end",e,r])});return{end:function(){e.removeListener("data",r);e.removeListener("end",o)},destroy:function(){this.end();(this||L).resume=function(){console.error("Cannot resume buffer after destroying it.")};r=o=t=e=null},resume:function(){this.end();for(var r=0,o=t.length;r<o;++r)e.emit.apply(e,t[r])}}};O.getMaxSockets=function(){return s};O.setMaxSockets=function(e){s=e};O.stack=function stack(e,t){var r;e.reverse().forEach((function(e){var o=r;r=function(r,n){var next=function(e){if(e){if(n._headerSent)n.destroy();else{n.statusCode=500;n.setHeader("Content-Type","text/plain");n.end("Internal Server Error")}console.error("Error in middleware(s): %s",e.stack)}else o&&o(r,n)};next.__proto__=t;e(r,n,next)}}));return r};O._getAgent=function _getAgent(e){if(!e||!e.host)throw new Error("`options.host` is required to create an Agent.");e.port||(e.port=e.https?443:80);var t=e.https?o.Agent:r.Agent,n;n=new t({host:e.host,port:e.port});n.maxSockets=e.maxSockets||s;return n};O._getProtocol=function _getProtocol(e){return e.https?o:r};O._getBase=function _getBase(e){var result=function(){};e.https&&"object"===typeof e.https&&["ca","cert","key"].forEach((function(t){e.https[t]&&(result.prototype[t]=e.https[t])}));return result};return q.exports}var R={},C=false;var $="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;function dew$6(){if(C)return R;C=true;var e=t;var o=r;var n=dew();var s=dew$5();var i={response:null,httpProxyServer:null,create:function(e,t,r,o,i,a){var c=this||$;(this||$).httpProxyServer=s.createServer((function(e,t,n){(this||$).peer=t.connection._peername;n.proxyRequest(e,t,{host:r,port:parseInt(o)});c.response=t})).listen(parseInt(t));n.watch((this||$).httpProxyServer,i,a);console.log("[37m [1m [46m Server started at [4m "+e+":"+t+"[0m")}};R=i;return R}var j={},I=false;function dew$7(){if(I)return j;I=true;var t=f;var r=e;var o=dew$6();var n='-s <localhost> -p <1337> -r <localhost> -t<80> -d </var/www/kinncj> -c ["ls -la"]';r.version("0.0.1").usage(n).option("-s, --server <server> -no-","Specify the local server","localhost").option("-p, --localport <localport> -no-","Local port","1337").option("-r, --remoteserver <remoteserver> -no-","Remote Server","localhost").option("-t, --remoteport <remoteport> -no-","Remote server port","80").option("-d, --directory <directory> -no-","Directory to watch","/tmp").option("-c, --command [command] -no-","A command to run for each update","ls -ls").parse(t.argv);function check(e){switch(true){case e.localport:case e.remoteserver:case e.server:case e.remoteport:case e.directory:console.log("Usage: refresh "+n);return false;break}return true}if(check(r)){try{o.create(r.server,r.localport,r.remoteserver,r.remoteport,r.directory,r.command)}catch(e){console.log(e)}return j}}var H=dew$7();export default H;export{dew$7 as __dew};

