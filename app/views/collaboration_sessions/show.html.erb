<% content_for :title, "Collaborative Editing - #{@session.session_name}" %>
<% content_for :head do %>
  <%= stylesheet_link_tag 'collaboration', 'data-turbo-track': 'reload' %>
<% end %>

<div class="collaboration-container" 
     data-controller="collaboration"
     data-collaboration-session-token-value="<%= @session.session_token %>"
     data-collaboration-content-type-value="<%= @content.class.name.downcase %>"
     data-collaboration-content-id-value="<%= @content.id %>"
     data-collaboration-user-id-value="<%= current_user.id %>"
     data-collaboration-user-name-value="<%= current_user.name %>">
  
  <!-- Main Editor Area -->
  <div class="collaboration-main">
    <!-- Session Controls -->
    <div class="session-controls">
      <div class="session-info">
        <div class="session-name"><%= @session.session_name %></div>
        <div class="session-details">
          <%= @content.class.name %>: <%= @content.respond_to?(:title) ? @content.title : @content.name %>
          • <%= pluralize(@session.active_participants.count, 'participant') %>
          • Started <%= time_ago_in_words(@session.started_at) %> ago
        </div>
      </div>
      
      <div class="session-actions">
        <% if @session.user_permission(current_user) == 'admin' %>
          <% if @session.status == 'active' %>
            <button class="session-btn" onclick="this.dataset.controller = 'collaboration'; this.dispatchEvent(new CustomEvent('collaboration:pause'))">
              Pause Session
            </button>
          <% elsif @session.status == 'paused' %>
            <button class="session-btn primary" onclick="this.dataset.controller = 'collaboration'; this.dispatchEvent(new CustomEvent('collaboration:resume'))">
              Resume Session
            </button>
          <% end %>
          <button class="session-btn danger" onclick="this.dataset.controller = 'collaboration'; this.dispatchEvent(new CustomEvent('collaboration:end'))">
            End Session
          </button>
        <% else %>
          <%= link_to "Leave Session", leave_collaboration_session_path(@session), 
                      method: :delete, class: "session-btn", 
                      confirm: "Are you sure you want to leave this session?" %>
        <% end %>
        
        <button class="session-btn" onclick="this.dataset.controller = 'collaboration'; this.dispatchEvent(new CustomEvent('collaboration:save'))">
          Save Content
        </button>
      </div>
    </div>
    
    <!-- Editor -->
    <div class="collaboration-editor">
      <div class="version-indicator" data-collaboration-target="status">
        Connected
      </div>
      
      <!-- Cursors Overlay -->
      <div class="collaboration-cursors" data-collaboration-target="cursors"></div>
      
      <!-- Content Editor -->
      <% case @content %>
      <% when Assignment %>
        <div class="editor-section">
          <h3>Assignment Title</h3>
          <input type="text" class="form-control" value="<%= @content.title %>" readonly>
        </div>
        
        <div class="editor-section">
          <h3>Assignment Content</h3>
          <textarea data-collaboration-target="editor" 
                    class="form-control"
                    rows="20"
                    placeholder="Assignment description and instructions..."><%= @content.content %></textarea>
        </div>
        
        <div class="editor-section">
          <h3>Due Date</h3>
          <input type="datetime-local" class="form-control" value="<%= @content.due_date&.strftime('%Y-%m-%dT%H:%M') %>" readonly>
        </div>
      
      <% when Note %>
        <div class="editor-section">
          <h3>Note Title</h3>
          <input type="text" class="form-control" value="<%= @content.title %>" readonly>
        </div>
        
        <div class="editor-section">
          <h3>Note Content</h3>
          <div data-collaboration-target="editor" 
               contenteditable="true"
               class="content-editor"
               style="min-height: 400px; padding: 16px; border: 1px solid #d1d5db; border-radius: 8px;"><%= simple_format(@content.content) %></div>
        </div>
      
      <% when Quiz %>
        <div class="editor-section">
          <h3>Quiz Title</h3>
          <input type="text" class="form-control" value="<%= @content.title %>" readonly>
        </div>
        
        <div class="editor-section">
          <h3>Quiz Instructions</h3>
          <textarea data-collaboration-target="editor" 
                    class="form-control"
                    rows="10"
                    placeholder="Quiz instructions..."><%= @content.instructions %></textarea>
        </div>
        
        <% if @content.questions.any? %>
          <div class="editor-section">
            <h3>Questions</h3>
            <div class="questions-list">
              <% @content.questions.each_with_index do |question, index| %>
                <div class="question-item" data-question-id="<%= question.id %>">
                  <h4>Question <%= index + 1 %></h4>
                  <textarea class="form-control question-content" 
                            rows="3"
                            readonly><%= question.content %></textarea>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
    
    <!-- Typing Indicators -->
    <div class="typing-indicators" data-collaboration-target="status">
      <!-- Typing indicators will be inserted here -->
    </div>
    
    <!-- Status Bar -->
    <div class="collaboration-status-bar">
      <div class="collaboration-status success" data-collaboration-target="status">
        Connected
      </div>
      
      <div class="connection-quality">
        Connection Quality
        <div class="connection-bars">
          <div class="connection-bar active"></div>
          <div class="connection-bar active"></div>
          <div class="connection-bar active"></div>
          <div class="connection-bar"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sidebar -->
  <div class="collaboration-sidebar">
    <!-- Participants Panel -->
    <div class="participants-panel">
      <div class="participants-header">
        Participants
        <span class="participants-count"><%= @session.active_participants.count %></span>
      </div>
      
      <div data-collaboration-target="participants">
        <% @session.active_participants.includes(:user).each do |participant| %>
          <div class="participant" data-user-id="<%= participant.user_id %>">
            <div class="participant-avatar" style="background-color: <%= participant_color(participant.user_id) %>">
              <% if participant.user.avatar.attached? %>
                <%= image_tag participant.user.avatar, alt: participant.user.name %>
              <% else %>
                <%= participant.user.name.first.upcase %>
              <% end %>
            </div>
            <div class="participant-info">
              <div class="participant-name">
                <%= participant.user.name %>
                <% if participant.user == current_user %>
                  <span class="badge badge-primary">You</span>
                <% end %>
              </div>
              <div class="participant-status <%= participant.online? ? 'online' : 'away' %>">
                <%= participant.permission_level.capitalize %> • 
                <%= participant.online? ? 'Online' : 'Away' %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
      
      <% if @session.user_permission(current_user) == 'admin' %>
        <div class="mt-3">
          <button class="btn btn-sm btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#inviteModal">
            Invite Participants
          </button>
        </div>
      <% end %>
    </div>
    
    <!-- Comments Panel -->
    <div class="comments-panel">
      <div class="comments-header">
        Comments
        <button class="add-comment-btn" onclick="this.closest('[data-controller]').querySelector('[data-controller=\"collaboration\"]').dispatchEvent(new CustomEvent('collaboration:add-comment'))">
          Add Comment
        </button>
      </div>
      
      <div data-collaboration-target="comments">
        <!-- Comments will be loaded dynamically -->
        <div class="text-muted text-center py-3">
          No comments yet. Add one to start the discussion!
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Version History Modal -->
<div class="modal fade" id="versionHistoryModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Version History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="versionHistoryContent">
          <!-- Version history will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Invite Participants Modal -->
<% if @session.user_permission(current_user) == 'admin' %>
  <div class="modal fade" id="inviteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Invite Participants</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <%= form_with url: invite_collaboration_session_path(@session), method: :post, local: false, id: "inviteForm" do |form| %>
            <div class="mb-3">
              <label class="form-label">Select Users</label>
              <select name="user_ids[]" class="form-select" multiple size="6">
                <% User.where.not(id: @session.session_participants.pluck(:user_id)).each do |user| %>
                  <option value="<%= user.id %>"><%= user.name %> (<%= user.email %>)</option>
                <% end %>
              </select>
              <div class="form-text">Hold Ctrl/Cmd to select multiple users</div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Permission Level</label>
              <select name="permission" class="form-select">
                <option value="viewer">Viewer (read-only)</option>
                <option value="editor" selected>Editor (can edit)</option>
                <option value="admin">Admin (full control)</option>
              </select>
            </div>
          <% end %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="inviteForm" class="btn btn-primary">Send Invitations</button>
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- Session Settings Modal -->
<div class="modal fade" id="sessionSettingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Session Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Session Name</label>
          <input type="text" class="form-control" value="<%= @session.session_name %>" readonly>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Maximum Participants</label>
          <input type="number" class="form-control" value="<%= @session.max_participants %>" readonly>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Session Status</label>
          <span class="badge <%= @session.status == 'active' ? 'bg-success' : 'bg-warning' %>">
            <%= @session.status.capitalize %>
          </span>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Session Metrics</label>
          <div class="row">
            <div class="col-6">
              <div class="text-center">
                <div class="h4"><%= @session.edit_operations.count %></div>
                <div class="text-muted">Total Edits</div>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center">
                <div class="h4"><%= @session.collaboration_events.where(event_type: 'comment').count %></div>
                <div class="text-muted">Comments</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// Additional JavaScript for collaboration features
document.addEventListener('DOMContentLoaded', function() {
  // Handle invite form submission
  const inviteForm = document.getElementById('inviteForm');
  if (inviteForm) {
    inviteForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      
      fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('[name=\"csrf-token\"]').content
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.invited_users && data.invited_users.length > 0) {
          // Show success message
          const message = `Invited ${data.invited_users.length} user(s) successfully`;
          showNotification(message, 'success');
          
          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('inviteModal'));
          modal.hide();
          
          // Reset form
          this.reset();
        }
        
        if (data.errors && data.errors.length > 0) {
          // Show errors
          data.errors.forEach(error => {
            showNotification(error, 'error');
          });
        }
      })
      .catch(error => {
        showNotification('Failed to send invitations', 'error');
      });
    });
  }
  
  // Show notification function
  function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `collaboration-notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
  
  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
      switch (e.key) {
        case 's':
          e.preventDefault();
          // Trigger save
          const controller = document.querySelector('[data-controller=\"collaboration\"]');
          if (controller) {
            controller.dispatchEvent(new CustomEvent('collaboration:save'));
          }
          break;
      }
    }
  });
});
</script>

<style>
/* Additional inline styles for specific elements */
.editor-section {
  margin-bottom: 24px;
}

.editor-section h3 {
  font-size: 16px;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 8px;
}

.content-editor {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  color: #1f2937;
}

.content-editor:focus {
  outline: 2px solid #3b82f6;
  outline-offset: -2px;
}

.questions-list {
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  overflow: hidden;
}

.question-item {
  padding: 16px;
  border-bottom: 1px solid #e2e8f0;
}

.question-item:last-child {
  border-bottom: none;
}

.question-item h4 {
  font-size: 14px;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 8px;
}

.question-content {
  font-size: 14px;
  background: #f8fafc;
}

.badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  background: #3b82f6;
  color: white;
  margin-left: 4px;
}
</style>