<% content_for :title, "Learning Insights Analytics" %>
  
  .effectiveness-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
  }
  
  .effectiveness-card {
    background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
    border-radius: 12px;
    padding: 20px;
    border-left: 4px solid #10b981;
  }
  
  .effectiveness-title {
    font-weight: 600;
    color: #065f46;
    margin-bottom: 12px;
  }
  
  .effectiveness-value {
    font-size: 2rem;
    font-weight: 700;
    color: #059669;
  }
  
  .accuracy-meter {
    background: #f1f5f9;
    border-radius: 20px;
    height: 12px;
    position: relative;
    overflow: hidden;
    margin: 12px 0;
  }
  
  .accuracy-fill {
    height: 100%;
    border-radius: 20px;
    background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
    transition: width 0.3s ease;
  }
  
  .trend-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .trend-table th,
  .trend-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .trend-table th {
    background: #f8fafc;
    font-weight: 600;
    color: #374151;
  }
  
  .trend-table tr:hover {
    background: #f9fafb;
  }
  
  .export-section {
    background: #f8fafc;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
  }
  
  .filter-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .filter-tab {
    padding: 12px 20px;
    background: none;
    border: none;
    color: #64748b;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease;
  }
  
  .filter-tab.active {
    color: #4f46e5;
    border-bottom-color: #4f46e5;
  }
  
  .filter-tab:hover {
    color: #1e293b;
    background: #f1f5f9;
  }
  
  .time-range-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
  }
  
  .time-range-btn {
    padding: 8px 16px;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }
  
  .time-range-btn.active {
    background: #4f46e5;
    color: white;
    border-color: #4f46e5;
  }
  
  .time-range-btn:hover:not(.active) {
    background: #e2e8f0;
  }
</style>
<% end %>

<div class="analytics-header">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="mb-2"><i class="fas fa-chart-bar me-2"></i>Learning Insights Analytics</h1>
      <p class="mb-0 opacity-90">Comprehensive analysis of AI-powered learning insights performance</p>
    </div>
    <div class="d-flex gap-2">
      <%= link_to learning_insights_path, class: "btn btn-outline-light btn-sm" do %>
        <i class="fas fa-arrow-left me-1"></i>Back to Insights
      <% end %>
      <%= link_to predictive_dashboard_learning_insights_path, class: "btn btn-light btn-sm" do %>
        <i class="fas fa-crystal-ball me-1"></i>Predictions
      <% end %>
    </div>
  </div>
</div>

<!-- Time Range Selector -->
<div class="analytics-card">
  <div class="time-range-selector">
    <button class="time-range-btn active" data-range="7d">Last 7 Days</button>
    <button class="time-range-btn" data-range="30d">Last 30 Days</button>
    <button class="time-range-btn" data-range="90d">Last 90 Days</button>
    <button class="time-range-btn" data-range="1y">Last Year</button>
    <button class="time-range-btn" data-range="all">All Time</button>
  </div>
</div>

<!-- Key Metrics Overview -->
<div class="metric-grid">
  <div class="metric-card">
    <span class="metric-value text-primary"><%= @analytics_data[:insight_distribution][:by_type].values.sum %></span>
    <div class="metric-label">Total Insights Generated</div>
    <div class="metric-trend trend-up">
      <i class="fas fa-arrow-up me-1"></i>12% vs last period
    </div>
  </div>
  
  <div class="metric-card">
    <span class="metric-value text-success">
      <%= number_to_percentage(@analytics_data[:effectiveness_metrics][:implementation_rate] * 100, precision: 1) %>
    </span>
    <div class="metric-label">Implementation Rate</div>
    <div class="metric-trend trend-up">
      <i class="fas fa-arrow-up me-1"></i>5% vs last period
    </div>
  </div>
  
  <div class="metric-card">
    <span class="metric-value text-warning">
      <%= @analytics_data[:effectiveness_metrics][:average_resolution_time].round(1) %>d
    </span>
    <div class="metric-label">Avg Resolution Time</div>
    <div class="metric-trend trend-down">
      <i class="fas fa-arrow-down me-1"></i>1.2d vs last period
    </div>
  </div>
  
  <div class="metric-card">
    <span class="metric-value text-info">
      <%= number_to_percentage(@analytics_data[:accuracy_metrics][:overall_accuracy] * 100, precision: 1) %>
    </span>
    <div class="metric-label">Overall Accuracy</div>
    <div class="metric-trend trend-stable">
      <i class="fas fa-minus me-1"></i>Stable
    </div>
  </div>
</div>

<!-- Tabbed Analytics Content -->
<div class="analytics-card">
  <div class="filter-tabs">
    <button class="filter-tab active" data-tab="distribution">Distribution</button>
    <button class="filter-tab" data-tab="effectiveness">Effectiveness</button>
    <button class="filter-tab" data-tab="trends">Trends</button>
    <button class="filter-tab" data-tab="accuracy">Accuracy</button>
    <button class="filter-tab" data-tab="engagement">User Engagement</button>
  </div>
  
  <!-- Distribution Tab -->
  <div class="tab-content" id="distribution-tab">
    <h3 class="mb-4">Insight Distribution Analysis</h3>
    
    <div class="row">
      <div class="col-md-6">
        <h5 class="mb-3">By Insight Type</h5>
        <div class="distribution-chart">
          <% @analytics_data[:insight_distribution][:by_type].each do |type, count| %>
            <div class="distribution-item">
              <span class="distribution-value"><%= count %></span>
              <div class="distribution-label"><%= type.humanize %></div>
            </div>
          <% end %>
        </div>
      </div>
      
      <div class="col-md-6">
        <h5 class="mb-3">By Priority Level</h5>
        <div class="distribution-chart">
          <% @analytics_data[:insight_distribution][:by_priority].each do |priority, count| %>
            <div class="distribution-item">
              <span class="distribution-value"><%= count %></span>
              <div class="distribution-label"><%= priority.humanize %></div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-6">
        <h5 class="mb-3">By Department</h5>
        <div class="chart-container">
          <div class="chart-placeholder">
            <div class="text-center">
              <i class="fas fa-chart-pie fa-3x mb-3"></i>
              <div>Department Distribution Chart</div>
              <small class="text-muted">Visual chart would be rendered here</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <h5 class="mb-3">Monthly Trends</h5>
        <div class="chart-container">
          <div class="chart-placeholder">
            <div class="text-center">
              <i class="fas fa-chart-line fa-3x mb-3"></i>
              <div>Monthly Trends Chart</div>
              <small class="text-muted">Time series chart would be rendered here</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Effectiveness Tab -->
  <div class="tab-content" id="effectiveness-tab" style="display: none;">
    <h3 class="mb-4">Effectiveness Metrics</h3>
    
    <div class="effectiveness-grid">
      <div class="effectiveness-card">
        <div class="effectiveness-title">Implementation Rate</div>
        <div class="effectiveness-value">
          <%= number_to_percentage(@analytics_data[:effectiveness_metrics][:implementation_rate] * 100, precision: 1) %>
        </div>
        <p class="text-sm text-muted mb-0">Percentage of insights that were successfully implemented</p>
      </div>
      
      <div class="effectiveness-card">
        <div class="effectiveness-title">Dismissal Rate</div>
        <div class="effectiveness-value">
          <%= number_to_percentage(@analytics_data[:effectiveness_metrics][:dismissal_rate] * 100, precision: 1) %>
        </div>
        <p class="text-sm text-muted mb-0">Percentage of insights that were dismissed as not actionable</p>
      </div>
      
      <div class="effectiveness-card">
        <div class="effectiveness-title">Avg Resolution Time</div>
        <div class="effectiveness-value">
          <%= @analytics_data[:effectiveness_metrics][:average_resolution_time].round(1) %> days
        </div>
        <p class="text-sm text-muted mb-0">Average time from generation to action</p>
      </div>
    </div>
    
    <div class="mt-4">
      <h5 class="mb-3">Effectiveness by Insight Type</h5>
      <table class="trend-table">
        <thead>
          <tr>
            <th>Insight Type</th>
            <th>Total Generated</th>
            <th>Implemented</th>
            <th>Dismissed</th>
            <th>Success Rate</th>
          </tr>
        </thead>
        <tbody>
          <% @analytics_data[:effectiveness_metrics][:effectiveness_by_type].group_by { |k, v| k.first }.each do |type, data| %>
            <% implemented = data.find { |k, v| k.last == 'implemented' }&.last || 0 %>
            <% dismissed = data.find { |k, v| k.last == 'dismissed' }&.last || 0 %>
            <% total = implemented + dismissed %>
            <% success_rate = total > 0 ? (implemented.to_f / total * 100) : 0 %>
            <tr>
              <td><%= type.humanize %></td>
              <td><%= total %></td>
              <td><span class="text-success"><%= implemented %></span></td>
              <td><span class="text-secondary"><%= dismissed %></span></td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="accuracy-meter me-2 flex-grow-1">
                    <div class="accuracy-fill" style="width: <%= success_rate %>%"></div>
                  </div>
                  <span class="fw-bold"><%= success_rate.round(1) %>%</span>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Trends Tab -->
  <div class="tab-content" id="trends-tab" style="display: none;">
    <h3 class="mb-4">Trend Analysis</h3>
    
    <div class="row">
      <div class="col-md-12">
        <h5 class="mb-3">Monthly Generation Trends</h5>
        <div class="chart-container">
          <div class="chart-placeholder">
            <div class="text-center">
              <i class="fas fa-chart-area fa-3x mb-3"></i>
              <div>Monthly Trends Chart</div>
              <small class="text-muted">
                Showing insight generation trends over time<br>
                Data: <%= @analytics_data[:trend_analysis][:monthly_trends].inspect %>
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-6">
        <h5 class="mb-3">Type Trends</h5>
        <div class="chart-container">
          <div class="chart-placeholder">
            <div class="text-center">
              <i class="fas fa-chart-bar fa-3x mb-3"></i>
              <div>Insight Type Trends</div>
              <small class="text-muted">Trends by insight type over time</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <h5 class="mb-3">Priority Trends</h5>
        <div class="chart-container">
          <div class="chart-placeholder">
            <div class="text-center">
              <i class="fas fa-chart-line fa-3x mb-3"></i>
              <div>Priority Level Trends</div>
              <small class="text-muted">Priority distribution changes over time</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Accuracy Tab -->
  <div class="tab-content" id="accuracy-tab" style="display: none;">
    <h3 class="mb-4">Prediction Accuracy Metrics</h3>
    
    <div class="row">
      <div class="col-md-4">
        <div class="metric-card">
          <span class="metric-value text-success">
            <%= number_to_percentage(@analytics_data[:accuracy_metrics][:overall_accuracy] * 100, precision: 1) %>
          </span>
          <div class="metric-label">Overall Accuracy</div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="metric-card">
          <span class="metric-value text-warning">
            <%= number_to_percentage(@analytics_data[:accuracy_metrics][:false_positive_rate] * 100, precision: 1) %>
          </span>
          <div class="metric-label">False Positive Rate</div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="metric-card">
          <span class="metric-value text-danger">
            <%= number_to_percentage(@analytics_data[:accuracy_metrics][:false_negative_rate] * 100, precision: 1) %>
          </span>
          <div class="metric-label">False Negative Rate</div>
        </div>
      </div>
    </div>
    
    <div class="mt-4">
      <h5 class="mb-3">Accuracy by Insight Type</h5>
      <table class="trend-table">
        <thead>
          <tr>
            <th>Insight Type</th>
            <th>Accuracy Rate</th>
            <th>Confidence</th>
            <th>Performance</th>
          </tr>
        </thead>
        <tbody>
          <% @analytics_data[:accuracy_metrics][:accuracy_by_type].each do |type, accuracy| %>
            <tr>
              <td><%= type.humanize %></td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="accuracy-meter me-2 flex-grow-1">
                    <div class="accuracy-fill" style="width: <%= accuracy * 100 %>%"></div>
                  </div>
                  <span class="fw-bold"><%= number_to_percentage(accuracy * 100, precision: 1) %></span>
                </div>
              </td>
              <td>
                <span class="badge bg-primary">High</span>
              </td>
              <td>
                <% if accuracy > 0.8 %>
                  <span class="text-success"><i class="fas fa-check-circle me-1"></i>Excellent</span>
                <% elsif accuracy > 0.7 %>
                  <span class="text-warning"><i class="fas fa-exclamation-circle me-1"></i>Good</span>
                <% else %>
                  <span class="text-danger"><i class="fas fa-times-circle me-1"></i>Needs Improvement</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- User Engagement Tab -->
  <div class="tab-content" id="engagement-tab" style="display: none;">
    <h3 class="mb-4">User Engagement with Insights</h3>
    
    <div class="row">
      <div class="col-md-4">
        <div class="metric-card">
          <span class="metric-value text-info">
            <%= number_to_percentage(@analytics_data[:user_engagement][:view_rate] * 100, precision: 1) %>
          </span>
          <div class="metric-label">View Rate</div>
          <small class="text-muted">Percentage of insights that are viewed</small>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="metric-card">
          <span class="metric-value text-success">
            <%= number_to_percentage(@analytics_data[:user_engagement][:action_rate] * 100, precision: 1) %>
          </span>
          <div class="metric-label">Action Rate</div>
          <small class="text-muted">Percentage of insights with actions taken</small>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="metric-card">
          <span class="metric-value text-primary">
            <%= @analytics_data[:user_engagement][:average_time_to_action] %>d
          </span>
          <div class="metric-label">Avg Time to Action</div>
          <small class="text-muted">Average days from view to action</small>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="analytics-card">
          <h5 class="mb-3">Engagement by User Role</h5>
          <div class="chart-container">
            <div class="chart-placeholder">
              <div class="text-center">
                <i class="fas fa-users fa-3x mb-3"></i>
                <div>User Role Engagement Chart</div>
                <small class="text-muted">Engagement breakdown by user role</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="analytics-card">
          <h5 class="mb-3">Response Time Distribution</h5>
          <div class="chart-container">
            <div class="chart-placeholder">
              <div class="text-center">
                <i class="fas fa-clock fa-3x mb-3"></i>
                <div>Response Time Histogram</div>
                <small class="text-muted">Distribution of response times</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Export Section -->
<div class="analytics-card">
  <div class="export-section">
    <h4 class="mb-3"><i class="fas fa-download me-2"></i>Export Analytics Data</h4>
    <p class="text-muted mb-3">Download comprehensive analytics reports in various formats</p>
    
    <div class="d-flex gap-2 flex-wrap">
      <%= link_to export_insights_learning_insights_path(format: 'csv'), 
          class: "btn btn-outline-primary" do %>
        <i class="fas fa-file-csv me-1"></i>Export CSV
      <% end %>
      
      <%= link_to export_insights_learning_insights_path(format: 'excel'), 
          class: "btn btn-outline-success" do %>
        <i class="fas fa-file-excel me-1"></i>Export Excel
      <% end %>
      
      <%= link_to export_insights_learning_insights_path(format: 'pdf'), 
          class: "btn btn-outline-danger" do %>
        <i class="fas fa-file-pdf me-1"></i>Export PDF Report
      <% end %>
    </div>
  </div>
</div>

<script>
// Tab switching functionality
document.addEventListener('DOMContentLoaded', function() {
  const tabs = document.querySelectorAll('.filter-tab');
  const contents = document.querySelectorAll('.tab-content');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      // Remove active class from all tabs and contents
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.style.display = 'none');
      
      // Add active class to clicked tab
      this.classList.add('active');
      
      // Show corresponding content
      const targetTab = this.dataset.tab;
      const targetContent = document.getElementById(targetTab + '-tab');
      if (targetContent) {
        targetContent.style.display = 'block';
      }
    });
  });
  
  // Time range selector
  const timeRangeButtons = document.querySelectorAll('.time-range-btn');
  timeRangeButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      timeRangeButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      // Here you would typically reload data for the selected time range
      const range = this.dataset.range;
      console.log('Time range changed to:', range);
      // loadAnalyticsData(range);
    });
  });
});

// Function to load analytics data (would make AJAX call)
function loadAnalyticsData(timeRange) {
  // This would make an AJAX call to reload the analytics data
  // for the selected time range
  console.log('Loading analytics data for:', timeRange);
}

// Auto-refresh analytics data every 5 minutes
setInterval(function() {
  // Auto-refresh logic would go here
  console.log('Auto-refreshing analytics data...');
}, 300000); // 5 minutes
</script>