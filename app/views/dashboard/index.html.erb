<% content_for :title, "Dashboard" %>

<div class="container mx-auto px-4 py-8" data-controller="dashboard" data-user-id="<%= current_user.id %>">
  <!-- Dashboard Header -->
  <div class="mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
      <div class="mb-4 md:mb-0">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Welcome back, <%= current_user.first_name %>!</h1>
        <p class="text-gray-600">
          <% case current_user.role %>
          <% when 'student' %>
            Here's your personalized learning dashboard
          <% when 'teacher' %>
            Manage your classes and track student progress
          <% when 'admin' %>
            Monitor system-wide activities and analytics
          <% else %>
            Your personalized dashboard
          <% end %>
        </p>
      </div>
      <div class="flex gap-2">
        <button type="button" 
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium" 
                data-action="click->dashboard#openWidgetCatalog"
                data-target="dashboard.addWidgetBtn">
          <i class="fas fa-plus mr-2"></i>Add Widget
        </button>
        <button type="button" 
                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm font-medium" 
                data-action="click->dashboard#resetDashboard">
          <i class="fas fa-undo mr-2"></i>Reset Layout
        </button>
        <%= link_to personalization_preferences_path, class: "px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm font-medium" do %>
          <i class="fas fa-palette mr-2"></i>Customize Theme
        <% end %>
      </div>
    </div>
  </div>

  <!-- Dashboard Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" 
       data-target="dashboard.grid"
       data-action="sortupdate->dashboard#onLayoutChange">
    
    <% current_user.dashboard_widgets.active.ordered.each do |widget| %>
      <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200" 
           data-widget-id="<%= widget.id %>"
           data-widget-type="<%= widget.widget_type %>"
           data-grid-x="<%= widget.grid_x %>"
           data-grid-y="<%= widget.grid_y %>"
           data-grid-width="<%= widget.width %>"
           data-grid-height="<%= widget.height %>">
        
        <!-- Widget Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
          <div class="flex items-center gap-2 font-semibold text-gray-800">
            <i class="<%= widget_icon(widget.widget_type) %> text-blue-600"></i>
            <%= widget.title %>
          </div>
          <div class="flex items-center gap-1">
            <button type="button" 
                    class="p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded transition"
                    data-action="click->dashboard#refreshWidget"
                    data-widget-id="<%= widget.id %>"
                    title="Refresh">
              <i class="fas fa-sync-alt text-sm"></i>
            </button>
            <button type="button" 
                    class="p-2 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded transition"
                    data-action="click->dashboard#configureWidget"
                    data-widget-id="<%= widget.id %>"
                    title="Configure">
              <i class="fas fa-cog text-sm"></i>
            </button>
            <button type="button" 
                    class="p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition"
                    data-action="click->dashboard#removeWidget"
                    data-widget-id="<%= widget.id %>"
                    title="Remove">
              <i class="fas fa-times text-sm"></i>
            </button>
          </div>
        </div>

        <!-- Widget Content -->
        <div class="p-4" data-target="dashboard.widgetContent">
          <%= render "dashboard/widgets/#{widget.widget_type}", widget: widget, data: @widget_service.get_widget_data(widget) %>
        </div>

        <!-- Widget Loading State -->
        <div class="hidden" data-target="dashboard.widgetLoading">
          <div class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-3 text-gray-600 text-sm">Refreshing widget...</p>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Empty State (when no widgets) -->
    <% if current_user.dashboard_widgets.active.empty? %>
      <div class="col-span-full text-center py-16 bg-white rounded-lg shadow" data-target="dashboard.emptyState">
        <div class="mb-6">
          <i class="fas fa-th-large text-6xl text-gray-300"></i>
        </div>
        <h4 class="text-2xl font-semibold text-gray-700 mb-3">Your Dashboard is Empty</h4>
        <p class="text-gray-500 mb-6">Start by adding some widgets to personalize your experience.</p>
        <button type="button" 
                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium" 
                data-action="click->dashboard#openWidgetCatalog">
          <i class="fas fa-plus mr-2"></i>Add Your First Widget
        </button>
      </div>
    <% end %>
  </div>

  <!-- Widget Catalog Modal -->
  <div x-data="{ open: false }" 
       @open-catalog.window="open = true"
       x-show="open"
       x-cloak
       class="fixed inset-0 z-50 overflow-y-auto"
       id="widgetCatalogModal" 
       data-target="dashboard.catalogModal"
       aria-labelledby="widgetCatalogModalLabel" 
       aria-hidden="true">
    <!-- Backdrop -->
    <div x-show="open" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50"
         @click="open = false"></div>
    
    <!-- Modal Content -->
    <div class="flex items-center justify-center min-h-screen px-4">
      <div x-show="open"
           x-transition:enter="transition ease-out duration-300"
           x-transition:enter-start="opacity-0 transform scale-95"
           x-transition:enter-end="opacity-100 transform scale-100"
           x-transition:leave="transition ease-in duration-200"
           x-transition:leave-start="opacity-100 transform scale-100"
           x-transition:leave-end="opacity-0 transform scale-95"
           class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
        
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
          <h5 class="text-xl font-semibold text-gray-900 flex items-center gap-2" id="widgetCatalogModalLabel">
            <i class="fas fa-store text-blue-600"></i>Widget Catalog
          </h5>
          <button type="button" 
                  @click="open = false"
                  class="text-gray-400 hover:text-gray-600 transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <!-- Body -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
          <div data-target="dashboard.catalog">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <% UserDashboardWidget::WIDGET_TYPES.each do |widget_type, widget_name| %>
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-blue-300 transition-all duration-200 cursor-pointer"
                     data-widget-type="<%= widget_type %>"
                     data-action="click->dashboard#selectWidget">
                  <div class="text-center mb-3">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-3">
                      <i class="<%= widget_icon(widget_type) %> text-2xl text-blue-600"></i>
                    </div>
                    <h6 class="font-semibold text-gray-900 mb-1"><%= widget_name %></h6>
                    <p class="text-gray-600 text-sm">
                      <%= widget_description(widget_type) %>
                    </p>
                  </div>
                  <button type="button" 
                          class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium"
                          data-action="click->dashboard#addWidget"
                          data-widget-type="<%= widget_type %>">
                    <i class="fas fa-plus mr-2"></i>Add Widget
                  </button>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="flex justify-end p-6 border-t border-gray-200">
          <button type="button" 
                  @click="open = false"
                  class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Widget Configuration Modal -->
  <div x-data="{ open: false }" 
       @open-config.window="open = true"
       x-show="open"
       x-cloak
       class="fixed inset-0 z-50 overflow-y-auto"
       id="widgetConfigModal" 
       data-target="dashboard.configModal"
       aria-labelledby="widgetConfigModalLabel" 
       aria-hidden="true">
    <!-- Backdrop -->
    <div x-show="open" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50"
         @click="open = false"></div>
    
    <!-- Modal Content -->
    <div class="flex items-center justify-center min-h-screen px-4">
      <div x-show="open"
           x-transition:enter="transition ease-out duration-300"
           x-transition:enter-start="opacity-0 transform scale-95"
           x-transition:enter-end="opacity-100 transform scale-100"
           x-transition:leave="transition ease-in duration-200"
           x-transition:leave-start="opacity-100 transform scale-100"
           x-transition:leave-end="opacity-0 transform scale-95"
           class="relative bg-white rounded-lg shadow-xl max-w-md w-full">
        
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
          <h5 class="text-xl font-semibold text-gray-900 flex items-center gap-2" id="widgetConfigModalLabel">
            <i class="fas fa-cog text-purple-600"></i>Configure Widget
          </h5>
          <button type="button" 
                  @click="open = false"
                  class="text-gray-400 hover:text-gray-600 transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <!-- Body -->
        <div class="p-6" data-target="dashboard.configForm">
          <!-- Dynamic configuration form will be loaded here -->
        </div>
        
        <!-- Footer -->
        <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
          <button type="button" 
                  @click="open = false"
                  class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
            Cancel
          </button>
          <button type="button" 
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium flex items-center gap-2" 
                  data-action="click->dashboard#saveWidgetConfig"
                  data-target="dashboard.saveConfigBtn">
            <span class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white" data-target="dashboard.configSpinner"></span>
            Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div class="fixed top-4 right-4 z-50 space-y-2" data-target="dashboard.toastContainer">
    <div class="hidden bg-white rounded-lg shadow-lg p-4 max-w-sm border-l-4 border-blue-600" 
         data-target="dashboard.toast" 
         role="alert" 
         aria-live="assertive" 
         aria-atomic="true"
         x-data="{ show: false }"
         x-show="show"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-x-8"
         x-transition:enter-end="opacity-100 transform translate-x-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
      <div class="flex items-center justify-between">
        <div class="flex-1" data-target="dashboard.toastBody">
          <!-- Message will be inserted here -->
        </div>
        <button type="button" 
                @click="show = false"
                class="ml-4 text-gray-400 hover:text-gray-600 transition">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  [x-cloak] { display: none !important; }
</style>

<!-- Include Sortable.js for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>