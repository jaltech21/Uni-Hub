<div class="widget-body">
  <% config = widget.configuration_with_defaults %>
  <% limit = config['limit'] || 6 %>
  <% show_replies = config['show_replies'] != false %>
  <% sort_by = config['sort_by'] || 'activity' %>
  
  <div class="discussion-feed">
    <% if data[:discussions]&.any? %>
      <div class="discussions-list">
        <% data[:discussions].first(limit).each do |discussion| %>
          <div class="discussion-item mb-3 p-3">
            <div class="d-flex align-items-start">
              <div class="discussion-avatar me-3">
                <% if discussion[:author_avatar].present? %>
                  <%= image_tag discussion[:author_avatar], class: 'rounded-circle', width: 40, height: 40 %>
                <% else %>
                  <div class="avatar-placeholder rounded-circle">
                    <%= discussion[:author_initials] || discussion[:author]&.first&.upcase || '?' %>
                  </div>
                <% end %>
              </div>
              
              <div class="discussion-content flex-grow-1">
                <div class="discussion-header mb-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <div class="discussion-title fw-semibold">
                        <%= discussion[:title] %>
                      </div>
                      <small class="text-muted">
                        by <%= discussion[:author] %> â€¢ 
                        <%= time_ago_in_words(discussion[:created_at]) %> ago
                        <% if discussion[:course].present? %>
                          in <span class="course-tag"><%= discussion[:course] %></span>
                        <% end %>
                      </small>
                    </div>
                    <% if discussion[:is_pinned] %>
                      <i class="fas fa-thumbtack text-warning" title="Pinned"></i>
                    <% end %>
                  </div>
                </div>
                
                <div class="discussion-preview text-muted mb-2">
                  <%= truncate(strip_tags(discussion[:content]), length: 120) %>
                </div>
                
                <div class="discussion-meta d-flex align-items-center gap-3">
                  <span class="meta-item">
                    <i class="fas fa-comments text-primary me-1"></i>
                    <%= discussion[:replies_count] || 0 %> <%= 'reply'.pluralize(discussion[:replies_count] || 0) %>
                  </span>
                  <span class="meta-item">
                    <i class="fas fa-eye text-secondary me-1"></i>
                    <%= discussion[:views_count] || 0 %> views
                  </span>
                  <% if discussion[:has_unread] %>
                    <span class="badge bg-primary">New</span>
                  <% end %>
                </div>
                
                <% if show_replies && discussion[:recent_replies]&.any? %>
                  <div class="recent-replies mt-2 ms-3 ps-3 border-start">
                    <% discussion[:recent_replies].first(2).each do |reply| %>
                      <div class="reply-item py-2">
                        <div class="d-flex align-items-start">
                          <small class="text-muted flex-grow-1">
                            <strong><%= reply[:author] %></strong>: 
                            <%= truncate(strip_tags(reply[:content]), length: 80) %>
                          </small>
                          <small class="text-muted ms-2">
                            <%= time_ago_in_words(reply[:created_at]) %> ago
                          </small>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-4">
        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
        <p class="text-muted mb-0">No discussions yet</p>
      </div>
    <% end %>
    
    <div class="discussion-footer mt-3 pt-3 border-top">
      <%= link_to discussions_path, class: 'btn btn-outline-primary btn-sm w-100' do %>
        <i class="fas fa-comments me-2"></i>View All Discussions
      <% end %>
    </div>
  </div>
</div>

<style>
  .discussion-feed {
    font-size: 0.9rem;
  }
  .discussion-feed .discussion-item {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .discussion-feed .discussion-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    cursor: pointer;
  }
  .discussion-feed .avatar-placeholder {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  .discussion-feed .discussion-title {
    font-size: 1rem;
    color: #212529;
    line-height: 1.4;
  }
  .discussion-feed .discussion-preview {
    font-size: 0.875rem;
    line-height: 1.5;
  }
  .discussion-feed .course-tag {
    background-color: #e7f1ff;
    color: #0d6efd;
    padding: 0.125rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
  }
  .discussion-feed .meta-item {
    font-size: 0.8rem;
    color: #6c757d;
  }
  .discussion-feed .recent-replies {
    font-size: 0.85rem;
    background-color: rgba(255,255,255,0.5);
    border-left-color: #dee2e6 !important;
  }
  .discussion-feed .reply-item {
    border-bottom: 1px solid #e9ecef;
  }
  .discussion-feed .reply-item:last-child {
    border-bottom: none;
  }
</style>
