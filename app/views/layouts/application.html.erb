<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Uni Hub" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Tailwind CSS compiled from npm %>
    <link rel="stylesheet" href="/assets/builds/application.css">
    <%= stylesheet_link_tag "personalization", "data-turbo-track": "reload" %>
    
    <%# Apply user personalization theme if available %>
    <% if user_signed_in? && current_user.user_personalization_preference.present? %>
      <% pref = current_user.user_personalization_preference %>
      <style>
        :root {
          <% pref.apply_theme_to_css.each do |property, value| %>
            <%= property %>: <%= value %>;
          <% end %>
        }
        
        <% if pref.accessibility_settings_with_defaults['high_contrast_mode'] %>
          body { filter: contrast(1.5); }
        <% end %>
        
        <% if pref.accessibility_settings_with_defaults['large_text'] %>
          body { font-size: 1.125rem; }
        <% end %>
        
        <% if pref.accessibility_settings_with_defaults['reduced_motion'] %>
          *, *::before, *::after { 
            animation-duration: 0.01ms !important; 
            animation-iteration-count: 1 !important; 
            transition-duration: 0.01ms !important; 
          }
        <% end %>
      </style>
    <% end %>
    
    <%# JavaScript files %>
    <%= javascript_importmap_tags %>
    
    <!-- Alpine.js for dropdown functionality -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Real-time Features Script -->
    <script>
      // Set current user ID for real-time features
      <% if user_signed_in? %>
        window.currentUserId = <%= current_user.id %>;
      <% end %>
    </script>
  </head>

  <body class="<%= theme_body_class %>" <% if user_signed_in? %>data-user-id="<%= current_user.id %>"<% end %>>
    <%= render 'layouts/navbar' %>
    <% if notice.present? %>
      <div class="bg-green-50 border-l-4 border-green-500 p-4">
        <p class="text-green-700"><%= notice %></p>
      </div>
    <% end %>
    <% if alert.present? %>
      <div class="bg-red-50 border-l-4 border-red-500 p-4">
        <p class="text-red-700"><%= alert %></p>
      </div>
    <% end %>
    <%= yield %>
    <%= render 'layouts/footer' %>
  </body>
</html>
