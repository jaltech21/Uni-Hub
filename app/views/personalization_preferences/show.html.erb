<% content_for :title, "Personalization Settings" %>

<div class="container mx-auto px-4 py-8">
  <!-- Page Header -->
  <div class="mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
      <div class="mb-4 md:mb-0">
        <h1 class="text-3xl font-bold <%= heading_theme_class %> mb-2">Personalization Settings</h1>
        <p class="<%= subtext_theme_class %>">Customize your Uni-Hub experience</p>
      </div>
      <div class="flex gap-2">
        <%= link_to "Back to Dashboard", dashboard_path, class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium" %>
        <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium" onclick="resetTheme(event)">
          Reset to Default
        </button>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Settings Panel -->
    <div class="lg:col-span-2">
      <div class="<%= card_theme_class %> rounded-lg shadow-md">
        <div class="p-6 border-b <%= border_theme_class %>">
          <h5 class="text-xl font-semibold <%= heading_theme_class %>">Appearance & Theme</h5>
        </div>
        <div class="p-6">
          <%= form_with model: @personalization_preference, 
                        url: personalization_preferences_path, 
                        method: :patch,
                        local: false,
                        html: { 
                          id: "personalization-form",
                          data: { 
                            action: "ajax:success->personalization#onUpdateSuccess ajax:error->personalization#onUpdateError" 
                          }
                        } do |form| %>
            
            <!-- Theme Selection -->
            <div class="mb-6">
              <label class="block text-sm font-semibold text-gray-700 mb-3">Theme</label>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <% @theme_options.each do |theme_key, theme_name| %>
                  <div class="cursor-pointer border-2 rounded-lg p-3 transition <%= @personalization_preference.theme == theme_key.to_s ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300' %>" 
                       data-theme="<%= theme_key %>">
                    <%= form.radio_button :theme, theme_key, 
                        class: "hidden",
                        data: { target: "personalization.themeInput" } %>
                    <div class="aspect-video mb-2 rounded overflow-hidden bg-gray-100">
                      <div class="h-full flex <%= theme_key == 'dark' ? 'bg-gray-900' : theme_key == 'blue' ? 'bg-blue-900' : theme_key == 'green' ? 'bg-green-900' : theme_key == 'purple' ? 'bg-purple-900' : 'bg-white' %>">
                        <div class="w-1/4 <%= theme_key == 'dark' ? 'bg-gray-800' : 'bg-gray-200' %>"></div>
                        <div class="flex-1 p-2">
                          <div class="h-2 <%= theme_key == 'dark' ? 'bg-gray-700' : 'bg-gray-300' %> rounded mb-1"></div>
                          <div class="h-2 w-3/4 <%= theme_key == 'dark' ? 'bg-gray-700' : 'bg-gray-300' %> rounded"></div>
                        </div>
                      </div>
                    </div>
                    <div class="text-center text-sm font-medium text-gray-700">
                      <%= theme_name %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Layout Style -->
            <div class="mb-6">
              <label class="block text-sm font-semibold text-gray-700 mb-3">Layout Style</label>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <% @layout_options.each do |layout_key, layout_name| %>
                  <div class="cursor-pointer border-2 rounded-lg p-3 transition <%= @personalization_preference.layout_style == layout_key.to_s ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300' %>" data-layout="<%= layout_key %>">
                    <%= form.radio_button :layout_style, layout_key,
                        class: "hidden" %>
                      <div class="aspect-video mb-2 rounded overflow-hidden bg-gray-100">
                        <div class="h-full flex flex-col">
                          <div class="h-2 bg-gray-300"></div>
                          <div class="flex-1 flex">
                            <div class="w-1/4 bg-gray-200"></div>
                            <div class="flex-1 p-2 space-y-1">
                              <div class="h-1 bg-gray-300 rounded"></div>
                              <div class="h-1 bg-gray-300 rounded w-3/4"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    <div class="text-center text-sm font-medium text-gray-700">
                      <%= layout_name %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Accessibility Options -->
            <div class="mb-6">
              <label class="block text-sm font-semibold text-gray-700 mb-3">Accessibility</label>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                  <%= form.check_box :accessibility_high_contrast, 
                      { checked: @personalization_preference.accessibility_settings_with_defaults['high_contrast_mode'] },
                      class: "w-5 h-5 text-blue-600 rounded focus:ring-blue-500" %>
                  <span class="text-sm font-medium text-gray-700">High Contrast</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                  <%= form.check_box :accessibility_large_text,
                      { checked: @personalization_preference.accessibility_settings_with_defaults['large_text'] },
                      class: "w-5 h-5 text-blue-600 rounded focus:ring-blue-500" %>
                  <span class="text-sm font-medium text-gray-700">Large Text</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                  <%= form.check_box :accessibility_reduced_motion,
                      { checked: @personalization_preference.accessibility_settings_with_defaults['reduced_motion'] },
                      class: "w-5 h-5 text-blue-600 rounded focus:ring-blue-500" %>
                  <span class="text-sm font-medium text-gray-700">Reduced Motion</span>
                </label>
              </div>
            </div>

            <!-- Display Options -->
            <div class="mb-6">
              <label class="block text-sm font-semibold text-gray-700 mb-3">Display Options</label>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                  <%= form.check_box :show_animations,
                      class: "w-5 h-5 text-blue-600 rounded focus:ring-blue-500",
                      data: { action: "change->personalization#updatePreview" } %>
                  <span class="text-sm font-medium text-gray-700">Show Animations</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                  <%= form.check_box :compact_mode,
                      class: "w-5 h-5 text-blue-600 rounded focus:ring-blue-500",
                      data: { action: "change->personalization#updatePreview" } %>
                  <span class="text-sm font-medium text-gray-700">Compact Mode</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                  <%= form.check_box :sidebar_collapsed,
                      class: "w-5 h-5 text-blue-600 rounded focus:ring-blue-500",
                      data: { action: "change->personalization#updatePreview" } %>
                  <span class="text-sm font-medium text-gray-700">Collapsed Sidebar</span>
                </label>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pt-4 border-t border-gray-200">
              <div x-data="{ open: false }" class="relative">
                <button type="button" 
                        @click="open = !open"
                        class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium flex items-center gap-2">
                  Apply Preset
                  <i class="fas fa-chevron-down text-xs" :class="{ 'rotate-180': open }"></i>
                </button>
                <div x-show="open" 
                     @click.away="open = false"
                     x-cloak
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:enter-start="transform opacity-0 scale-95"
                     x-transition:enter-end="transform opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-75"
                     x-transition:leave-start="transform opacity-100 scale-100"
                     x-transition:leave-end="transform opacity-0 scale-95"
                     class="absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10">
                  <% @preset_themes.each do |preset_key, preset_data| %>
                    <button type="button" 
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition" 
                            data-action="click->personalization#applyPreset"
                            data-preset="<%= preset_key %>"
                            @click="open = false">
                      <%= preset_key.to_s.humanize %>
                    </button>
                  <% end %>
                </div>
              </div>
              <button type="submit" 
                      class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium flex items-center gap-2" 
                      data-target="personalization.submitBtn">
                <span class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white" data-target="personalization.spinner"></span>
                Save Changes
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Live Preview Panel -->
    <div class="lg:col-span-1">
      <div class="<%= card_theme_class %> rounded-lg shadow-md sticky top-8">
        <div class="p-6 border-b <%= border_theme_class %>">
          <h5 class="text-xl font-semibold <%= heading_theme_class %>">Live Preview</h5>
        </div>
        <div class="p-4">
          <div class="bg-gray-100 rounded-lg overflow-hidden" data-personalization-target="preview">
            <!-- Navigation Bar -->
            <div class="bg-blue-600 text-white p-3 flex items-center justify-between" data-preview="navbar">
              <div class="font-bold text-sm">Uni-Hub</div>
              <div class="flex gap-2">
                <div class="w-12 h-2 bg-white bg-opacity-30 rounded"></div>
                <div class="w-12 h-2 bg-white bg-opacity-20 rounded"></div>
                <div class="w-12 h-2 bg-white bg-opacity-20 rounded"></div>
              </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="flex h-64">
              <!-- Sidebar -->
              <div class="w-16 bg-gray-200 p-2 space-y-2" data-preview="sidebar">
                <div class="h-8 bg-blue-500 rounded"></div>
                <div class="h-8 bg-gray-300 rounded"></div>
                <div class="h-8 bg-gray-300 rounded"></div>
                <div class="h-8 bg-gray-300 rounded"></div>
              </div>
              
              <!-- Content -->
              <div class="flex-1 bg-white p-4" data-preview="content">
                <div class="mb-4">
                  <div class="h-4 bg-gray-300 rounded w-1/2 mb-2"></div>
                  <div class="h-3 bg-gray-200 rounded w-1/3"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                  <div class="h-16 bg-gradient-to-br from-blue-100 to-blue-200 rounded"></div>
                  <div class="h-16 bg-gradient-to-br from-green-100 to-green-200 rounded"></div>
                  <div class="col-span-2 h-24 bg-gradient-to-br from-purple-100 to-purple-200 rounded"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success/Error Messages -->
<div class="fixed top-4 right-4 z-50" data-target="personalization.toastContainer">
  <div class="hidden bg-white rounded-lg shadow-lg p-4 max-w-sm border-l-4 border-blue-600" 
       data-target="personalization.toast" 
       role="alert"
       x-data="{ show: false }"
       x-show="show"
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0 transform translate-x-8"
       x-transition:enter-end="opacity-100 transform translate-x-0"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0">
    <div class="flex items-center justify-between">
      <div class="flex-1 text-gray-800" data-target="personalization.toastBody">
        <!-- Message will be inserted here -->
      </div>
      <button type="button" 
              @click="show = false"
              class="ml-4 text-gray-400 hover:text-gray-600 transition">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
</div>

<style>
  [x-cloak] { display: none !important; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Personalization vanilla JS loaded');
    
    // Initialize selected states
    initializeSelectedStates();
    
    // Add click handlers for theme cards
    document.querySelectorAll('[data-theme]').forEach(card => {
      card.addEventListener('click', function() {
        selectTheme(this);
      });
    });
    
    // Add click handlers for layout cards
    document.querySelectorAll('[data-layout]').forEach(card => {
      card.addEventListener('click', function() {
        selectLayout(this);
      });
    });
    
    function initializeSelectedStates() {
      // Initialize theme selection state
      const checkedThemeRadio = document.querySelector('input[name="user_personalization_preference[theme]"]:checked');
      if (checkedThemeRadio) {
        const themeValue = checkedThemeRadio.value;
        const themeCard = document.querySelector(`[data-theme="${themeValue}"]`);
        if (themeCard) {
          themeCard.classList.add('border-blue-500', 'bg-blue-50');
          themeCard.classList.remove('border-gray-200');
        }
      }

      // Initialize layout selection state
      const checkedLayoutRadio = document.querySelector('input[name="user_personalization_preference[layout_style]"]:checked');
      if (checkedLayoutRadio) {
        const layoutValue = checkedLayoutRadio.value;
        const layoutCard = document.querySelector(`[data-layout="${layoutValue}"]`);
        if (layoutCard) {
          layoutCard.classList.add('border-blue-500', 'bg-blue-50');
          layoutCard.classList.remove('border-gray-200');
        }
      }
      
      // Initialize the preview with the current selections
      updatePreview();
    }
    
    function selectTheme(themeCard) {
      console.log('Theme clicked:', themeCard);
      
      const theme = themeCard.dataset.theme;
      console.log('Selected theme:', theme);
      
      // Remove active class from all theme cards
      document.querySelectorAll('[data-theme]').forEach(card => {
        card.classList.remove('border-blue-500', 'bg-blue-50');
        card.classList.add('border-gray-200');
      });
      
      // Add active class to selected card
      console.log('Updating card classes');
      themeCard.classList.remove('border-gray-200');
      themeCard.classList.add('border-blue-500', 'bg-blue-50');
      
      // Check the corresponding radio button
      const radio = themeCard.querySelector('input[type="radio"]');
      if (radio) {
        radio.checked = true;
        console.log('Radio checked:', radio.value);
      }
      
      // Update preview
      updatePreview();
    }
    
    function selectLayout(layoutCard) {
      console.log('Layout clicked:', layoutCard);
      
      const layout = layoutCard.dataset.layout;
      console.log('Selected layout:', layout);
      
      // Remove active class from all layout cards
      document.querySelectorAll('[data-layout]').forEach(card => {
        card.classList.remove('border-blue-500', 'bg-blue-50');
        card.classList.add('border-gray-200');
      });
      
      // Add active class to selected card
      console.log('Updating layout card classes');
      layoutCard.classList.remove('border-gray-200');
      layoutCard.classList.add('border-blue-500', 'bg-blue-50');
      
      // Check the corresponding radio button
      const radio = layoutCard.querySelector('input[type="radio"]');
      if (radio) {
        radio.checked = true;
        console.log('Layout radio checked:', radio.value);
      }
      
      // Update preview
      updatePreview();
    }
    
    function updatePreview() {
      console.log("Updating preview...");
      
      const preview = document.querySelector('[data-personalization-target="preview"]');
      console.log("Preview element:", preview);
      
      if (!preview) {
        console.log("No preview target found");
        return;
      }

      const selectedTheme = document.querySelector('input[name="user_personalization_preference[theme]"]:checked');
      console.log("Selected theme radio:", selectedTheme);

      if (selectedTheme) {
        const theme = selectedTheme.value;
        console.log("Applying theme to preview:", theme);
        
        const navbar = preview.querySelector('[data-preview="navbar"]');
        const sidebar = preview.querySelector('[data-preview="sidebar"]');
        const content = preview.querySelector('[data-preview="content"]');
        
        console.log("Navbar element:", navbar);
        console.log("Sidebar element:", sidebar);
        console.log("Content element:", content);

        if (navbar && sidebar && content) {
          // Remove all background color classes
          const bgClasses = ['bg-blue-600', 'bg-blue-900', 'bg-gray-900', 'bg-green-900', 'bg-purple-900', 'bg-white',
                            'bg-gray-200', 'bg-gray-800', 'bg-blue-200', 'bg-green-200', 'bg-purple-200',
                            'bg-gray-100', 'bg-blue-100', 'bg-green-100', 'bg-purple-100', 'bg-gray-700'];
          
          bgClasses.forEach(cls => {
            navbar.classList.remove(cls);
            sidebar.classList.remove(cls);
            content.classList.remove(cls);
          });

          // Apply theme-specific colors
          switch(theme) {
            case 'dark':
              navbar.classList.add('bg-gray-900');
              sidebar.classList.add('bg-gray-800');
              content.classList.add('bg-gray-700');
              break;
            case 'blue':
              navbar.classList.add('bg-blue-900');
              sidebar.classList.add('bg-blue-200');
              content.classList.add('bg-blue-100');
              break;
            case 'green':
              navbar.classList.add('bg-green-900');
              sidebar.classList.add('bg-green-200');
              content.classList.add('bg-green-100');
              break;
            case 'purple':
              navbar.classList.add('bg-purple-900');
              sidebar.classList.add('bg-purple-200');
              content.classList.add('bg-purple-100');
              break;
            default: // light
              navbar.classList.add('bg-blue-600');
              sidebar.classList.add('bg-gray-200');
              content.classList.add('bg-white');
          }
          console.log("Preview updated successfully");
          console.log("Navbar classes:", navbar.className);
          console.log("Sidebar classes:", sidebar.className);
          console.log("Content classes:", content.className);
        } else {
          console.log("Could not find navbar, sidebar, or content elements");
        }
      }
      
      // Handle layout style changes
      const selectedLayout = document.querySelector('input[name="user_personalization_preference[layout_style]"]:checked');
      if (selectedLayout && preview) {
        const layout = selectedLayout.value;
        console.log("Applying layout to preview:", layout);
        
        const sidebar = preview.querySelector('[data-preview="sidebar"]');
        const content = preview.querySelector('[data-preview="content"]');
        
        if (sidebar) {
          // Reset width classes
          sidebar.classList.remove('w-16', 'w-12', 'w-20', 'w-8');
          
          // Apply layout-specific width
          switch(layout) {
            case 'compact':
              sidebar.classList.add('w-12');
              break;
            case 'spacious':
              sidebar.classList.add('w-20');
              break;
            case 'minimal':
              sidebar.classList.add('w-8');
              break;
            default: // standard
              sidebar.classList.add('w-16');
          }
        }
        
        if (content) {
          // Reset padding classes
          content.classList.remove('p-2', 'p-4', 'p-6', 'p-1');
          
          // Apply layout-specific padding
          switch(layout) {
            case 'compact':
              content.classList.add('p-2');
              break;
            case 'spacious':
              content.classList.add('p-6');
              break;
            case 'minimal':
              content.classList.add('p-1');
              break;
            default: // standard
              content.classList.add('p-4');
          }
        }
        
        console.log("Layout updated in preview");
      }
    }
    
    // Make resetTheme globally accessible
    window.resetTheme = function(event) {
      event.preventDefault();
      console.log("Resetting theme...");

      fetch(event.target.closest('button').getAttribute('data-url') || '/personalization_preferences/reset', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        }
      })
      .catch(error => console.error('Error:', error));
    };
  });
</script>
