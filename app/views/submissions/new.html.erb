<%
  # Check if student already has a submission
  existing_submission = @assignment.submissions.find_by(user_id: current_user.id)
  is_overdue = @assignment.due_date && @assignment.due_date < Time.current
  can_resubmit = @assignment.allow_resubmission && existing_submission
%>

<div class="min-h-screen bg-gray-50 py-8">
  <div class="container mx-auto px-4 max-w-4xl">
    <!-- Header -->
    <div class="mb-8">
      <%= link_to assignments_path, class: "inline-flex items-center text-gray-600 hover:text-gray-800 mb-4" do %>
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Back to Assignments
      <% end %>
      
      <h1 class="text-3xl font-bold text-gray-900">
        <%= existing_submission ? "Resubmit Assignment" : "Submit Assignment" %>
      </h1>
      <p class="text-gray-600 mt-2">Upload your work for this assignment</p>
    </div>

    <!-- Warning Messages -->
    <% if existing_submission && !@assignment.allow_resubmission %>
      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-yellow-800">Already Submitted</h3>
            <p class="mt-1 text-sm text-yellow-700">
              You have already submitted this assignment. Resubmissions are not allowed.
              <%= link_to "View your submission", assignment_submission_path(@assignment, existing_submission), class: "font-semibold underline" %>
            </p>
          </div>
        </div>
      </div>
    <% elsif is_overdue %>
      <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">⚠️ Late Submission Warning</h3>
            <p class="mt-1 text-sm text-red-700">
              This assignment was due on <%= @assignment.due_date.strftime("%B %d, %Y at %I:%M %p") %>.
              You are submitting late. Your teacher may apply late penalties.
            </p>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Main Content -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <!-- Assignment Details Panel -->
      <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6">
        <h2 class="text-2xl font-bold mb-4"><%= @assignment.title %></h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
            <div>
              <p class="text-xs text-blue-200">Course</p>
              <p class="font-semibold"><%= @assignment.course_name %></p>
            </div>
          </div>
          
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <div>
              <p class="text-xs text-blue-200">Due Date</p>
              <p class="font-semibold">
                <%= @assignment.due_date ? @assignment.due_date.strftime("%b %d, %Y") : "No due date" %>
              </p>
            </div>
          </div>
          
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
            </svg>
            <div>
              <p class="text-xs text-blue-200">Points Possible</p>
              <p class="font-semibold"><%= @assignment.points %> points</p>
            </div>
          </div>
        </div>

        <% if @assignment.description.present? %>
          <div class="mt-4 pt-4 border-t border-blue-500">
            <p class="text-xs text-blue-200 mb-2">Description</p>
            <p class="text-sm"><%= simple_format(@assignment.description) %></p>
          </div>
        <% end %>

        <% if @assignment.grading_criteria.present? %>
          <div class="mt-4 pt-4 border-t border-blue-500">
            <p class="text-xs text-blue-200 mb-2">Grading Criteria</p>
            <p class="text-sm"><%= simple_format(@assignment.grading_criteria) %></p>
          </div>
        <% end %>
      </div>

      <!-- Submission Form -->
      <% if !existing_submission || @assignment.allow_resubmission %>
        <%= form_with(model: [@assignment, @submission], local: true, html: { id: 'submission-form', class: "p-6" }) do |form| %>
          <% if @submission.errors.any? %>
            <div id="error_explanation" class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-red-800">
                    <%= pluralize(@submission.errors.count, "error") %> prevented this submission from being saved:
                  </h3>
                  <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
                    <% @submission.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          <% end %>

          <!-- File Upload Section -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Upload Files *
              <span class="text-gray-500 font-normal">(Required)</span>
            </label>
            
            <!-- Hidden file input -->
            <%= form.file_field :documents, 
                multiple: true, 
                accept: '.pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.zip,.rar',
                class: "hidden",
                id: "file-input",
                direct_upload: true %>
            
            <!-- Drag & Drop Zone -->
            <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors cursor-pointer">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              <p class="mt-2 text-sm text-gray-600">
                <button type="button" id="browse-button" class="font-semibold text-blue-600 hover:text-blue-500">
                  Click to browse
                </button>
                or drag and drop files here
              </p>
              <p class="text-xs text-gray-500 mt-1">
                PDF, DOC, DOCX, TXT, JPG, PNG, ZIP up to 10MB each
              </p>
            </div>

            <!-- File Preview List -->
            <div id="file-list" class="mt-4 space-y-2"></div>
            
            <!-- File validation message -->
            <p id="file-error" class="text-sm text-red-600 mt-2 hidden"></p>
            <p id="file-count" class="text-sm text-gray-600 mt-2">No files selected</p>
          </div>

          <!-- Comments/Notes Section (Optional) -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Comments or Notes
              <span class="text-gray-500 font-normal">(Optional)</span>
            </label>
            <%= form.text_area :content, 
                rows: 4,
                placeholder: "Add any comments or notes about your submission...",
                class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" %>
            <p class="text-xs text-gray-500 mt-1">This field is optional</p>
          </div>

          <!-- Confirmation Checkbox -->
          <div class="mb-6">
            <label class="flex items-start">
              <input type="checkbox" id="confirm-checkbox" class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">
                I confirm that this is my own work and I am ready to submit this assignment.
                <% if is_overdue %>
                  <strong class="text-red-600">I understand this is a late submission.</strong>
                <% end %>
              </span>
            </label>
          </div>

          <!-- Action Buttons -->
          <div class="flex items-center justify-between pt-6 border-t border-gray-200">
            <%= link_to "Cancel", assignments_path, 
                class: "px-6 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors font-medium" %>
            
            <%= form.submit existing_submission ? "Resubmit Assignment" : "Submit Assignment",
                id: "submit-button",
                disabled: true,
                class: "px-8 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:bg-gray-300 disabled:cursor-not-allowed" %>
          </div>

          <!-- Loading Indicator -->
          <div id="loading-indicator" class="hidden mt-4 text-center">
            <div class="inline-flex items-center px-4 py-2 bg-blue-50 rounded-lg">
              <svg class="animate-spin h-5 w-5 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span class="text-sm text-blue-700 font-medium">Uploading files, please wait...</span>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<!-- Vanilla JavaScript for File Upload Management -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const browseButton = document.getElementById('browse-button');
    const fileList = document.getElementById('file-list');
    const fileError = document.getElementById('file-error');
    const fileCount = document.getElementById('file-count');
    const confirmCheckbox = document.getElementById('confirm-checkbox');
    const submitButton = document.getElementById('submit-button');
    const submissionForm = document.getElementById('submission-form');
    const loadingIndicator = document.getElementById('loading-indicator');

    let selectedFiles = new DataTransfer();
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    const ALLOWED_TYPES = [
      'application/pdf',
      'application/msword',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'text/plain',
      'image/jpeg',
      'image/jpg',
      'image/png',
      'application/zip',
      'application/x-rar-compressed'
    ];

    // Open file picker when browse button or drop zone is clicked
    browseButton.addEventListener('click', (e) => {
      e.preventDefault();
      fileInput.click();
    });

    dropZone.addEventListener('click', (e) => {
      if (e.target !== browseButton) {
        fileInput.click();
      }
    });

    // Handle file selection
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    // Drag and drop handlers
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-blue-500', 'bg-blue-50');
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-500', 'bg-blue-50');
      handleFiles(e.dataTransfer.files);
    });

    // Handle files
    function handleFiles(files) {
      fileError.classList.add('hidden');
      fileError.textContent = '';

      for (let file of files) {
        // Validate file size
        if (file.size > MAX_FILE_SIZE) {
          showError(`${file.name} is too large. Maximum file size is 10MB.`);
          continue;
        }

        // Validate file type
        if (!ALLOWED_TYPES.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|txt|jpg|jpeg|png|zip|rar)$/i)) {
          showError(`${file.name} is not an allowed file type.`);
          continue;
        }

        // Check for duplicates
        let isDuplicate = false;
        for (let i = 0; i < selectedFiles.files.length; i++) {
          if (selectedFiles.files[i].name === file.name && selectedFiles.files[i].size === file.size) {
            isDuplicate = true;
            break;
          }
        }

        if (isDuplicate) {
          showError(`${file.name} is already added.`);
          continue;
        }

        // Add file to DataTransfer
        selectedFiles.items.add(file);
      }

      // Update file input
      fileInput.files = selectedFiles.files;

      // Update UI
      updateFileList();
      updateSubmitButton();
    }

    // Update file list display
    function updateFileList() {
      fileList.innerHTML = '';
      
      if (selectedFiles.files.length === 0) {
        fileCount.textContent = 'No files selected';
        return;
      }

      fileCount.textContent = `${selectedFiles.files.length} file(s) selected`;

      for (let i = 0; i < selectedFiles.files.length; i++) {
        const file = selectedFiles.files[i];
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200';
        
        fileItem.innerHTML = `
          <div class="flex items-center space-x-3 flex-1 min-w-0">
            <svg class="w-8 h-8 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
              <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
            </div>
          </div>
          <button type="button" class="remove-file ml-3 p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded flex-shrink-0" data-index="${i}">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </button>
        `;
        
        fileList.appendChild(fileItem);
      }

      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-file').forEach(button => {
        button.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.dataset.index);
          removeFile(index);
        });
      });
    }

    // Remove file
    function removeFile(index) {
      const newFiles = new DataTransfer();
      
      for (let i = 0; i < selectedFiles.files.length; i++) {
        if (i !== index) {
          newFiles.items.add(selectedFiles.files[i]);
        }
      }
      
      selectedFiles = newFiles;
      fileInput.files = selectedFiles.files;
      
      updateFileList();
      updateSubmitButton();
    }

    // Show error message
    function showError(message) {
      fileError.textContent = message;
      fileError.classList.remove('hidden');
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Update submit button state
    function updateSubmitButton() {
      const hasFiles = selectedFiles.files.length > 0;
      const isConfirmed = confirmCheckbox.checked;
      submitButton.disabled = !(hasFiles && isConfirmed);
    }

    // Checkbox change handler
    confirmCheckbox.addEventListener('change', updateSubmitButton);

    // Form submit handler
    submissionForm.addEventListener('submit', (e) => {
      if (selectedFiles.files.length === 0) {
        e.preventDefault();
        showError('Please select at least one file to upload.');
        return;
      }

      if (!confirmCheckbox.checked) {
        e.preventDefault();
        showError('Please confirm that you are ready to submit.');
        return;
      }

      // Show loading indicator
      submitButton.disabled = true;
      loadingIndicator.classList.remove('hidden');
    });
  });
</script>