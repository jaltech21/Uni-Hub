#!/usr/bin/env ruby
# frozen_string_literal: true

# Quick test script to verify AI provider setup
require_relative '../config/environment'

puts "=" * 60
puts "AI PROVIDER SETUP VERIFICATION"
puts "=" * 60
puts

# Check environment variables
puts "üìã Environment Configuration:"
puts "  AI_PROVIDER: #{ENV['AI_PROVIDER'] || 'not set (will default to gemini)'}"
puts "  GEMINI_API_KEY: #{ENV['GEMINI_API_KEY'] ? '‚úÖ Set' : '‚ùå Not set'}"
puts "  OPENAI_API_KEY: #{ENV['OPENAI_API_KEY'] ? '‚úÖ Set (inactive)' : '‚ùå Not set'}"
puts "  AI_MOCK_MODE: #{ENV['AI_MOCK_MODE']}"
puts

# Initialize provider
puts "üîß Initializing AI Provider..."
begin
  provider = AiServiceFactory.provider
  provider_class = provider.class.name
  provider_name = provider.send(:provider_name)
  
  puts "  ‚úÖ Provider initialized: #{provider_class}"
  puts "  üì¶ Provider name: #{provider_name}"
  puts "  üéØ Rate limit: #{provider.max_requests_per_hour} requests/hour"
  puts
rescue StandardError => e
  puts "  ‚ùå Failed to initialize provider: #{e.message}"
  puts
  exit 1
end

# Test rate limiting
puts "üìä Testing Rate Limiter..."
test_user_id = 1
can_make_request = provider.can_make_request?(test_user_id)
remaining = provider.remaining_requests(test_user_id)
puts "  User #{test_user_id} can make request: #{can_make_request}"
puts "  Remaining requests: #{remaining}/#{provider.max_requests_per_hour}"
puts

# Check available providers
puts "üîç Available Providers:"
AiServiceFactory::PROVIDERS.each do |name, class_name|
  status = if name == ENV['AI_PROVIDER']&.downcase || (name == 'gemini' && !ENV['AI_PROVIDER'])
             "‚úÖ ACTIVE"
           else
             "  inactive"
           end
  puts "  #{status} #{name} (#{class_name})"
end
puts

# Provider-specific checks
puts "üß™ Provider-Specific Checks:"
case provider_name
when 'gemini'
  puts "  ‚úÖ Gemini provider active"
  puts "  üìù Model: #{AiProviders::GeminiProvider::GEMINI_MODEL}"
  puts "  üÜì Free tier: 60 req/min, 1,500 req/day"
when 'openai'
  puts "  ‚ö†Ô∏è  OpenAI provider active (no credits available)"
  puts "  üìù Model: #{AiProviders::OpenaiProvider::OPENAI_MODEL}"
when 'mock'
  puts "  üé≠ Mock provider active (simulated responses)"
end
puts

# Database check
puts "üìä Database Status:"
log_count = AiUsageLog.count
puts "  Total AI usage logs: #{log_count}"
if log_count > 0
  puts "  Recent actions:"
  AiUsageLog.recent.limit(3).each do |log|
    status_emoji = case log.status
                   when 'success' then '‚úÖ'
                   when 'failure' then '‚ùå'
                   when 'rate_limited' then '‚ö†Ô∏è'
                   else '‚ùì'
                   end
    puts "    #{status_emoji} #{log.action} (#{log.provider || 'unknown'}) - #{log.created_at.strftime('%Y-%m-%d %H:%M')}"
  end
end
puts

puts "=" * 60
puts "‚ú® SETUP VERIFICATION COMPLETE"
puts "=" * 60
puts
puts "Next steps:"
puts "  1. Restart your Rails server (bin/dev)"
puts "  2. Visit /quizzes/generate to test quiz generation"
puts "  3. Visit /summarizations/new to test text summarization"
puts "  4. Check /admin/ai_analytics for usage statistics"
puts
